<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>2025 ä¹å·æ—…è¡ŒæŒ‡æ®ä¸­å¿ƒ V21</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  
  <!-- Fonts & Icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+TC:wght@400;500;700;900&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
  
  <style>
    :root {
      /* ä¹å·å°è±¡è‰² */
      --primary: #1e3a8a;       
      --primary-light: #3b82f6; 
      --accent: #f97316;        
      --bg-body: #f4f5f7;       
      --bg-surface: #ffffff;
      --text-main: #1e293b;
      --text-sub: #64748b;
      --border: #e2e8f0;
      
      /* Semantic Colors */
      --color-transport: #0ea5e9;
      --color-food: #f97316;
      --color-spot: #10b981;
      --color-stay: #8b5cf6;
      
      /* Shadows */
      --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.05);
      --shadow-card: 0 4px 12px rgba(0,0,0,0.05), 0 1px 3px rgba(0,0,0,0.05);
      --shadow-float: 0 20px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { 
        font-family: 'Inter', 'Noto Sans TC', sans-serif; 
        background: var(--bg-body); margin: 0; 
        color: var(--text-main); line-height: 1.6; 
        padding-bottom: 90px;
        overflow-x: hidden;
    }

    /* --- Buttons --- */
    .btn { 
        padding: 8px 16px; border-radius: 12px; border: 1px solid var(--border); 
        background: white; cursor: pointer; font-size: 13px; font-weight: 600; 
        display: inline-flex; align-items: center; gap: 6px; transition: all 0.2s; 
        color: var(--text-main); box-shadow: var(--shadow-sm);
    }
    .btn:active { transform: scale(0.98); }
    .btn-primary { background: var(--primary); color: white; border: none; }
    .btn-danger { color: #ef4444; background: #fef2f2; border-color: #fee2e2; }
    .icon-btn { background: none; border: none; cursor: pointer; padding: 8px; border-radius: 50%; color: var(--text-sub); }
    .icon-btn:hover { background: rgba(0,0,0,0.05); color: var(--text-main); }

    /* --- Portal --- */
    #portal { 
        position: fixed; inset: 0; background: radial-gradient(circle at top right, #1e293b, #0f172a); 
        z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; 
        color: white; transition: opacity 0.4s; 
    }
    #portal.hidden { opacity: 0; pointer-events: none; }
    .portal-cards { display: flex; gap: 16px; flex-wrap: wrap; justify-content: center; max-width: 800px; }
    .portal-card { 
        background: rgba(255,255,255,0.1); backdrop-filter: blur(12px); 
        border: 1px solid rgba(255,255,255,0.15); border-radius: 24px; 
        padding: 32px 24px; width: 160px; cursor: pointer; text-align: center; 
        transition: transform 0.3s, background 0.3s; 
    }
    .portal-card:hover { transform: translateY(-8px); background: rgba(255,255,255,0.2); }

    /* --- Mobile View --- */
    #mobile-view { display: none; max-width: 600px; margin: 0 auto; background: #f4f5f7; min-height: 100vh; }
    #mobile-view.active { display: block; animation: fadeIn 0.4s; }

    .m-header {
        background: linear-gradient(135deg, var(--primary) 0%, #3b82f6 100%);
        color: white; padding: 24px 20px 60px;
        border-radius: 0 0 32px 32px; position: relative;
        box-shadow: 0 10px 30px -10px rgba(30, 58, 138, 0.5);
    }
    .m-header-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
    .m-trip-title { font-size: 28px; line-height: 1.2; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .m-trip-subtitle { font-size: 13px; opacity: 0.9; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; }

    .m-day-selector-container {
        margin-top: -40px; padding: 0 20px; overflow-x: auto; 
        white-space: nowrap; scrollbar-width: none; padding-bottom: 20px;
    }
    .m-day-btn {
        display: inline-flex; flex-direction: column; align-items: center; justify-content: center;
        width: 60px; height: 70px; background: white; border-radius: 35px;
        margin-right: 12px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        transition: all 0.2s; border: 2px solid transparent; color: var(--text-sub); flex-shrink: 0;
    }
    .m-day-btn.active {
        background: var(--primary); color: white; transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(30, 58, 138, 0.3); border-color: white;
    }
    .m-day-num { font-size: 18px; font-weight: 800; line-height: 1; margin-bottom: 2px; }
    .m-day-txt { font-size: 10px; font-weight: 600; }

    .m-content { padding: 0 20px; }
    .m-tip-card {
        background: white; border-radius: 16px; padding: 16px;
        border-left: 4px solid var(--accent); box-shadow: var(--shadow-card); margin-bottom: 24px;
        display: flex; gap: 12px; align-items: flex-start;
    }
    .m-tip-icon { color: var(--accent); background: #fff7ed; padding: 8px; border-radius: 50%; }
    
    .m-timeline { position: relative; padding-left: 24px; }
    .m-timeline-line { 
        position: absolute; left: 11px; top: 10px; bottom: 0; 
        width: 2px; background: repeating-linear-gradient(to bottom, #cbd5e1 0, #cbd5e1 6px, transparent 6px, transparent 12px); 
        z-index: 0; 
    }
    .m-event-item { position: relative; margin-bottom: 32px; z-index: 1; }
    .m-event-icon-box {
        position: absolute; left: -24px; top: 0; width: 24px; height: 24px; border-radius: 50%;
        background: white; border: 2px solid var(--border); display: flex; align-items: center; justify-content: center;
        z-index: 2; color: var(--text-sub); font-size: 14px;
    }
    .type-move .m-event-icon-box { border-color: var(--color-transport); color: var(--color-transport); background: #f0f9ff; }
    .type-food .m-event-icon-box { border-color: var(--color-food); color: var(--color-food); background: #fff7ed; }
    .type-spot .m-event-icon-box { border-color: var(--color-spot); color: var(--color-spot); background: #f0fdf4; }
    .type-stay .m-event-icon-box { border-color: var(--color-stay); color: var(--color-stay); background: #f5f3ff; }

    .m-event-card {
        background: white; border-radius: 16px; overflow: hidden;
        box-shadow: var(--shadow-card); transition: transform 0.2s; cursor: pointer;
        border: 1px solid rgba(0,0,0,0.03);
    }
    .m-event-card:active { transform: scale(0.98); }
    .m-card-img { height: 120px; width: 100%; background-size: cover; background-position: center; position: relative; display: none; }
    .m-card-img.has-img { display: block; }
    .m-img-badge { position: absolute; bottom: 8px; left: 8px; background: rgba(0,0,0,0.6); color: white; font-size: 10px; padding: 2px 8px; border-radius: 99px; backdrop-filter: blur(4px); }

    .m-card-body { padding: 16px; }
    .m-card-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
    .m-time-badge { background: #f1f5f9; color: var(--text-main); font-family: 'JetBrains Mono'; font-size: 12px; padding: 2px 8px; border-radius: 6px; font-weight: 600; }
    
    .tag-transport-warning { background: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; display: flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 99px; font-size: 10px; margin-top: 6px; width: fit-content; }

    .m-card-title { font-size: 16px; font-weight: 700; color: var(--text-main); margin-bottom: 6px; line-height: 1.4; }
    .m-card-desc { font-size: 13px; color: var(--text-sub); line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .m-card-footer { margin-top: 12px; padding-top: 12px; border-top: 1px dashed var(--border); display: flex; justify-content: space-between; align-items: center; }
    .m-cost { font-weight: 700; color: var(--text-main); font-size: 14px; }
    .m-cost.paid { color: #10b981; display: flex; align-items: center; gap: 4px; }

    /* --- Desktop View --- */
    #desktop-view { display: none; max-width: 1800px; margin: 0 auto; padding: 24px; }
    #desktop-view.active { display: block; animation: fadeIn 0.5s; }
    .d-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 20px; border-radius: 16px; border: 1px solid var(--border); }

    /* --- Database View (Restored!) --- */
    #db-view { display: none; max-width: 1200px; margin: 0 auto; padding: 24px; }
    #db-view.active { display: block; animation: fadeIn 0.5s; }
    
    .db-toolbar { display: flex; gap: 12px; margin-bottom: 20px; background: white; padding: 16px; border-radius: 16px; border: 1px solid var(--border); flex-wrap: wrap; }
    .db-search { flex: 1; padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; outline: none; font-size: 14px; min-width: 200px; }
    .db-filter { padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; background: white; font-size: 13px; cursor: pointer; transition: all 0.2s; }
    .db-filter.active { background: var(--primary); color: white; border-color: var(--primary); }
    
    .db-table-container { background: white; border-radius: 16px; border: 1px solid var(--border); overflow: hidden; box-shadow: var(--shadow-sm); margin-bottom: 24px; }
    .db-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .db-table th { background: #f8fafc; padding: 12px 16px; text-align: left; border-bottom: 2px solid var(--border); color: var(--text-sub); font-weight: 600; position: sticky; top: 0; }
    .db-table td { padding: 12px 16px; border-bottom: 1px solid var(--border); color: var(--text-main); vertical-align: top; }
    .db-table tr:hover { background: #f1f5f9; cursor: pointer; }
    
    .tag-type { padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; display: inline-block; text-transform: uppercase; }
    .tag-type.move { background: #e0f2fe; color: #0369a1; }
    .tag-type.food { background: #fff7ed; color: #c2410c; }
    .tag-type.spot { background: #f0fdf4; color: #15803d; }
    .tag-type.stay { background: #f5f3ff; color: #7e22ce; }
    
    .db-section-title { font-size: 16px; font-weight: 700; color: var(--primary); margin-bottom: 12px; margin-top: 32px; display: flex; align-items: center; gap: 8px; }

    /* --- Bottom Nav --- */
    .bottom-nav {
        position: fixed; bottom: 0; left: 0; width: 100%;
        background: rgba(255,255,255,0.95); backdrop-filter: blur(20px);
        border-top: 1px solid rgba(0,0,0,0.05);
        display: flex; justify-content: space-around; padding: 10px 0;
        z-index: 1000; padding-bottom: calc(10px + env(safe-area-inset-bottom));
        box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
    }
    .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; background: none; border: none; color: #94a3b8; font-size: 10px; font-weight: 600; cursor: pointer; width: 20%; }
    .nav-item span { font-size: 24px; transition: transform 0.2s; }
    .nav-item.active { color: var(--primary); }
    .nav-item.active span { transform: translateY(-2px); }

    /* --- Drawers & Modals --- */
    .drawer-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(2px); z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
    .drawer-backdrop.active { opacity: 1; pointer-events: auto; }
    .detail-drawer { position: fixed; top: 0; left: 0; bottom: 0; width: 450px; max-width: 90%; background: white; z-index: 2001; transform: translateX(-100%); transition: transform 0.3s ease; display: flex; flex-direction: column; box-shadow: 10px 0 50px rgba(0,0,0,0.15); }
    .detail-drawer.active { transform: translateX(0); }

    /* Desktop Timeline Styles (Restored V16 logic with V20 skin) */
    .event-block {
        position: absolute; left: 40px; right: 8px; border-radius: 8px; padding: 6px 8px;
        font-size: 12px; cursor: pointer; border-left: 4px solid; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: all 0.2s;
        display: flex; flex-direction: column; justify-content: center; overflow: hidden;
        background: white;
    }
    .event-block:hover { transform: scale(1.03); z-index: 50; box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
    .type-move.d-block { background-color: #f0f9ff; border-left-color: var(--color-transport); border: 1px dashed #bae6fd; border-left: 4px solid var(--color-transport); }
    .type-food.d-block { background-color: #fff7ed; border-left-color: var(--color-food); }
    .type-spot.d-block { background-color: #f0fdf4; border-left-color: var(--color-spot); }
    .type-stay.d-block { background-color: #f5f3ff; border-left-color: var(--color-stay); }

    /* Editor Modal */
    #editor-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2100; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
    .editor-modal { background: white; width: 90%; max-width: 450px; border-radius: 24px; padding: 24px; max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow-float); animation: fadeIn 0.2s; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body>

  <!-- Portal -->
  <div id="portal">
    <h1 style="font-size:32px; font-weight:800; margin-bottom:8px;">2025 ä¹å·æŒ‡æ®ä¸­å¿ƒ</h1>
    <div style="font-size:14px; opacity:0.8; margin-bottom:40px;">V21 é›™æ ¸æ——è‰¦ç‰ˆï¼šè¨­è¨ˆç¾å­¸ X ç¡¬æ ¸è³‡æ–™åº«</div>
    <div class="portal-cards">
        <div class="portal-card" onclick="switchTab('mobile')">
            <span class="material-symbols-rounded" style="font-size:40px;">smartphone</span>
            <div style="font-weight:700;">éš¨è¡Œæ¨¡å¼</div>
        </div>
        <div class="portal-card" onclick="switchTab('desktop')">
            <span class="material-symbols-rounded" style="font-size:40px;">view_timeline</span>
            <div style="font-weight:700;">æˆ°ç•¥è¦–åœ–</div>
        </div>
        <div class="portal-card" onclick="switchTab('db')">
            <span class="material-symbols-rounded" style="font-size:40px;">table_view</span>
            <div style="font-weight:700;">è³‡æ–™åº«</div>
        </div>
    </div>
  </div>

  <!-- Mobile View -->
  <div id="mobile-view">
    <div class="m-header">
        <div class="m-header-top">
            <div>
                <div class="m-trip-subtitle">JAPAN TRIP 2025</div>
                <div class="m-trip-title">ä¹å·ç¸±æ–·<br>éµé“æº«æ³‰ä¹‹æ—…</div>
            </div>
            <div class="m-weather-badge">
                <div style="font-size:20px; font-weight:800;">8Â°C</div>
                <div style="font-size:10px;">é æ¸¬å¹³å‡</div>
            </div>
        </div>
    </div>
    <div class="m-day-selector-container" id="m-day-selector"></div>
    <div class="m-content">
        <div class="m-tip-card">
            <div class="m-tip-icon"><span class="material-symbols-rounded">lightbulb</span></div>
            <div>
                <div style="font-size:12px; font-weight:700; color:var(--accent); margin-bottom:4px;">ä»Šæ—¥é‡é» / è€å¸«å‚…å®åš€</div>
                <div id="m-daily-advice" style="font-size:14px; color:var(--text-main); line-height:1.5;"></div>
            </div>
        </div>
        <div class="m-timeline" id="m-timeline-list"></div>
        <div style="height: 40px;"></div>
    </div>
  </div>

  <!-- Desktop View -->
  <div id="desktop-view">
      <div class="d-header">
          <div>
              <div style="font-size:12px; color:var(--text-sub); font-weight:700;">COMMAND CENTER</div>
              <h1 style="color:var(--primary);">è¡Œç¨‹æˆ°ç•¥è¦–åœ–</h1>
          </div>
          <div style="display:flex; gap:10px;">
              <button class="btn" onclick="exportData()">å‚™ä»½ JSON</button>
              <button class="btn" onclick="importData()">é‚„åŸ</button>
              <button class="btn btn-primary" onclick="window.print()">åˆ—å°</button>
          </div>
          <input type="file" id="import-file" style="display:none" onchange="processImport(this)">
      </div>
      <div style="overflow:auto; border:1px solid var(--border); border-radius:16px; height:80vh;">
          <table id="desktop-table" style="width:100%; min-width:1600px; border-collapse:separate; border-spacing:0;">
              <thead><tr id="d-header-row" style="position:sticky; top:0; background:#f8fafc; z-index:10;"></tr></thead>
              <tbody id="d-body-row"></tbody>
          </table>
      </div>
  </div>

  <!-- Database View (The Real Deal) -->
  <div id="db-view">
      <div class="d-header">
          <div>
              <div style="font-size:12px; color:var(--text-sub); font-weight:700;">DATABASE</div>
              <h1 style="color:var(--primary);">å®Œæ•´è¡Œç¨‹è³‡æ–™åº«</h1>
          </div>
          <button class="btn" onclick="switchTab('desktop')">è¿”å›åœ–è¡¨</button>
      </div>

      <div class="db-toolbar">
          <input type="text" class="db-search" placeholder="æœå°‹è¡Œç¨‹ã€å‚™è¨»..." onkeyup="renderDB(this.value)">
          <button class="db-filter active" onclick="filterDb('all')">å…¨éƒ¨</button>
          <button class="db-filter" onclick="filterDb('move')">äº¤é€š</button>
          <button class="db-filter" onclick="filterDb('food')">ç¾é£Ÿ</button>
          <button class="db-filter" onclick="filterDb('spot')">æ™¯é»</button>
          <button class="db-filter" onclick="filterDb('stay')">ä½å®¿</button>
      </div>

      <div class="db-table-container">
          <table class="db-table">
              <thead>
                  <tr>
                      <th style="width:120px">æ—¥æœŸ</th>
                      <th style="width:100px">æ™‚é–“</th>
                      <th style="width:80px">é¡å‹</th>
                      <th>åç¨±</th>
                      <th>è©³ç´°å‚™è¨» & æ”»ç•¥</th>
                      <th style="width:100px">é ç®—</th>
                      <th style="width:60px">æ“ä½œ</th>
                  </tr>
              </thead>
              <tbody id="db-tbody">
                  <!-- JS Injected -->
              </tbody>
          </table>
      </div>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:24px;">
          <div>
              <div class="db-section-title"><span class="material-symbols-rounded">store</span> åº—å®¶ç‡Ÿæ¥­è³‡è¨Š & Tips</div>
              <div class="db-table-container">
                  <table class="db-table">
                      <thead><tr><th>åç¨±</th><th>ç‡Ÿæ¥­æ™‚é–“</th><th>Tips</th></tr></thead>
                      <tbody id="ref-spot-tbody"></tbody>
                  </table>
              </div>
          </div>
          <div>
              <div class="db-section-title"><span class="material-symbols-rounded">school</span> æ¯æ—¥è€å¸«å‚…å®åš€</div>
              <div class="db-table-container">
                  <table class="db-table">
                      <thead><tr><th>æ—¥æœŸ</th><th>å»ºè­°</th></tr></thead>
                      <tbody id="ref-expert-tbody"></tbody>
                  </table>
              </div>
          </div>
      </div>
  </div>

  <!-- Bottom Nav -->
  <div class="bottom-nav">
      <button class="nav-item active" onclick="switchTab('mobile')"><span class="material-symbols-rounded">explore</span>è¡Œç¨‹</button>
      <button class="nav-item" onclick="switchTab('desktop')"><span class="material-symbols-rounded">map</span>æˆ°ç•¥åœ–</button>
      <button class="nav-item" onclick="switchTab('db')"><span class="material-symbols-rounded">table_rows</span>è³‡æ–™åº«</button>
      <button class="nav-item" onclick="exportData()"><span class="material-symbols-rounded">save</span>å‚™ä»½</button>
  </div>

  <!-- Detail Drawer -->
  <div class="drawer-backdrop" id="drawer-backdrop" onclick="closeDrawer()"></div>
  <div class="detail-drawer" id="detail-drawer">
      <div class="drawer-header">
          <div>
             <div class="text-sm font-weight-bold text-sub" id="d-drawer-type">TYPE</div>
             <div style="font-size:20px; font-weight:800;" id="d-drawer-title">Title</div>
          </div>
          <button class="icon-btn" onclick="closeDrawer()"><span class="material-symbols-rounded">close</span></button>
      </div>
      <div class="drawer-body">
          <div id="d-drawer-img-container" style="margin-bottom:20px; display:none;">
              <img id="d-drawer-img" src="" style="width:100%; height:180px; object-fit:cover; border-radius:12px;">
          </div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:20px;">
              <div style="background:#f1f5f9; padding:12px; border-radius:12px;">
                  <div class="text-xs text-sub">æ™‚é–“</div>
                  <div class="font-mono font-weight-bold" id="d-drawer-time"></div>
              </div>
              <div style="background:#f1f5f9; padding:12px; border-radius:12px;">
                  <div class="text-xs text-sub">é ç®—</div>
                  <div class="font-mono font-weight-bold" id="d-drawer-cost"></div>
              </div>
          </div>
          <div id="d-drawer-planb" style="display:none; background:#f1f5f9; padding:12px; border-radius:12px; margin-bottom:20px; border:1px dashed var(--text-sub);">
              <div style="font-weight:700; font-size:13px; display:flex; align-items:center; gap:6px;">
                  <span class="material-symbols-rounded">rainy</span> å‚™æ¡ˆè¡Œç¨‹
              </div>
              <div id="d-drawer-planb-text" style="font-size:13px; margin-top:4px; color:var(--text-sub);"></div>
          </div>
          <div style="margin-bottom:20px;">
              <div class="text-xs font-weight-bold text-sub" style="margin-bottom:6px;">è©³ç´°æ”»ç•¥ & å‚™è¨»</div>
              <div id="d-drawer-desc" style="font-size:14px; line-height:1.6;"></div>
          </div>
          <div style="background:#f0f9ff; padding:16px; border-radius:12px; border:1px solid #bae6fd; margin-bottom:20px;">
              <div style="font-size:11px; font-weight:700; color:#0284c7; margin-bottom:6px;">ğŸ‘¨â€ğŸ« è€å¸«å‚…å»ºè­°</div>
              <div id="d-drawer-advice" style="font-size:13px; color:#0c4a6e;"></div>
          </div>
          <button class="btn" style="width:100%; justify-content:center;" onclick="openMap()">
              <span class="material-symbols-rounded">map</span> Google Maps å°èˆª
          </button>
      </div>
      <div class="drawer-footer">
          <button class="btn btn-danger" onclick="deleteEvent()">åˆªé™¤</button>
          <button class="btn btn-primary" onclick="openEditor()">ç·¨è¼¯ / åŠ ç…§ç‰‡</button>
      </div>
  </div>

  <!-- Editor Modal -->
  <div id="editor-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:2100; justify-content:center; align-items:center; backdrop-filter:blur(4px);">
      <div class="editor-modal">
          <h3 style="margin-top:0;">ç·¨è¼¯è¡Œç¨‹</h3>
          <input type="hidden" id="e-day-id"><input type="hidden" id="e-id">
          <div style="margin-bottom:12px;">
              <label class="text-xs font-weight-bold text-sub">æ¨™é¡Œ</label>
              <input id="e-title" class="btn" style="width:100%; text-align:left; cursor:text;" placeholder="è¡Œç¨‹åç¨±">
          </div>
          <div style="display:flex; gap:10px; margin-bottom:12px;">
              <div style="flex:1"><label class="text-xs font-weight-bold text-sub">é–‹å§‹</label><input type="time" id="e-start" class="btn" style="width:100%;"></div>
              <div style="flex:1"><label class="text-xs font-weight-bold text-sub">çµæŸ</label><input type="time" id="e-end" class="btn" style="width:100%;"></div>
          </div>
          <div style="display:flex; gap:10px; margin-bottom:12px;">
              <div style="flex:1">
                  <label class="text-xs font-weight-bold text-sub">é¡å‹</label>
                  <select id="e-type" class="btn" style="width:100%;">
                      <option value="move">äº¤é€š</option><option value="food">ç¾é£Ÿ</option><option value="spot">æ™¯é»</option><option value="stay">ä½å®¿</option>
                  </select>
              </div>
              <div style="flex:1"><label class="text-xs font-weight-bold text-sub">é ç®—</label><input type="number" id="e-cost" class="btn" style="width:100%; cursor:text;" placeholder="0"></div>
          </div>
          <div style="margin-bottom:12px;">
              <label class="text-xs font-weight-bold text-sub">å°é¢åœ–ç‰‡ç¶²å€</label>
              <input id="e-img" class="btn" style="width:100%; text-align:left; cursor:text;">
          </div>
          <div style="margin-bottom:12px;">
              <label class="text-xs font-weight-bold text-sub">å‚™æ¡ˆ</label>
              <input id="e-planb" class="btn" style="width:100%; text-align:left; cursor:text;">
          </div>
          <div style="margin-bottom:20px;">
              <label class="text-xs font-weight-bold text-sub">è©³ç´°å‚™è¨»</label>
              <textarea id="e-desc" class="btn" style="width:100%; height:80px; text-align:left; cursor:text; resize:none;"></textarea>
          </div>
          <div style="display:flex; justify-content:flex-end; gap:10px;">
              <button class="btn" onclick="closeEditor()">å–æ¶ˆ</button>
              <button class="btn btn-primary" onclick="saveEvent()">å„²å­˜</button>
          </div>
      </div>
  </div>

  <script>
    const STORAGE_KEY = 'kyushu_v21_final';
    
    const daysMeta = [
      {id:1, date:'12/10', w:'Wed', city:'åˆ¥åºœ'}, {id:2, date:'12/11', w:'Thu', city:'å¤§åˆ†'}, 
      {id:3, date:'12/12', w:'Fri', city:'ç”±å¸ƒé™¢'}, {id:4, date:'12/13', w:'Sat', city:'æµ®ç¾½'}, 
      {id:5, date:'12/14', w:'Sun', city:'åŸé¶´'}, {id:6, date:'12/15', w:'Mon', city:'åšå¤š'},
      {id:7, date:'12/16', w:'Tue', city:'åŒ—ä¹å·'}, {id:8, date:'12/17', w:'Wed', city:'åšå¤š'}, 
      {id:9, date:'12/18', w:'Thu', city:'è¿”ç¨‹'}
    ];

    // Reference Data
    const spotDB = {
      "ç„¼è‚‰ ä¸€åŠ›": { open:"17:00-24:00 (æœ¨æ›œä¼‘)", tips:"ç…™å‘³é‡ï¼Œé¿é–‹æ·ºè‰²è¡£ç‰©ï¼Œå»ºè­°å…ˆè¨‚ä½" },
      "ã¨ã‚ˆå¸¸": { open:"11:00-21:00 (ç«/æ°´ä¼‘)", tips:"ç‰¹ä¸Šå¤©ä¸¼å¿…é»ï¼Œå»ºè­°11:00å‰æ’éšŠ" },
      "å‹æ°¸ãƒ‘ãƒ³å±‹": { open:"08:30-17:30 (æ—¥æ›œä¼‘)", tips:"åœ¨åœ°ç™¾å¹´éºµåŒ…åº—ï¼Œåªèƒ½ä»˜ç¾ï¼Œè³£å®Œææ—©é—œ" },
      "ShinShin": { open:"11:00-03:00", tips:"ç´”æƒ…è±šéª¨æ‹‰éºµï¼Œæ’éšŠäººæ½®å¤š" },
      "é¶´è¦‹å²³çºœè»Š": { open:"09:00-17:00", tips:"å‡ºç™¼å‰å‹™å¿…çœ‹å®˜ç¶² Live Cam ç¢ºèªå±±ä¸Šå¤©æ°£" },
      "City Spa": { open:"14:00-24:00 (æ™¨æ¹¯6:00-9:30)", tips:"é ‚æ¨“éœ²å¤©æº«æ³‰å¿…æ³¡ï¼Œæ—¥è½èˆ‡å¤œæ™¯çš†ç¾" },
      "æ³°æ³‰é–£": { open:"å¢æ—é¢¨å‘‚æœ‰ç”·å¥³äº’æ›åˆ¶", tips:"**æ—©é¤æ–¹æ¡ˆ**ï¼Œæ™šé¤éœ€åœ¨å¤–é¢è§£æ±ºæˆ–è²·é€²å»" },
      "MINOU BOOKS": { open:"11:00-19:00 (ç«æ›œä¼‘)", tips:"æµ®ç¾½å¿…é€›è³ªæ„Ÿæ›¸åº—" },
      "FUK COFFEE": { open:"08:00-20:00", tips:"é£›æ©Ÿä¸»é¡Œå’–å•¡ï¼Œé©åˆæ‹ç…§" },
      "æµ·é®®å±…é…’å±‹ ã‚Œã‚“": { open:"17:00-23:00 (æ—¥æ›œä¼‘)", tips:"Tabelog 3.73åˆ†ï¼Œåˆ¥åºœæ™šé¤é«˜åˆ†å‚™æ¡ˆ" },
      "Somuri": { open:"11:30-14:00 / 17:30-21:30", tips:"Tabelog 3.68åˆ†ï¼Œè±å¾Œç‰›æ’ï¼Œåˆé¤CPå€¼é«˜" },
      "IT750": { type:"move", desc:"TPE 12:00 -> OIT 15:00" },
      "ç©ºæ¸¯å·´å£«": { type:"move", desc:"AirLiner å¾€åˆ¥åºœåŒ—æµœï¼Œè»Šç¨‹ç´„50åˆ†" }
    };
    
    const IMG_YUFUIN = "https://images.unsplash.com/photo-1565619624098-e8c2c951a3e6?auto=format&fit=crop&w=600&q=80"; 
    const IMG_ROPEWAY = "https://images.unsplash.com/photo-1610327743468-7089e50e9244?auto=format&fit=crop&w=600&q=80"; 
    const IMG_BEEF = "https://images.unsplash.com/photo-1558030006-4506719866cf?auto=format&fit=crop&w=600&q=80"; 
    
    const defaultData = {
        events: {
            d1: [
                {id:'e1', start:'10:00', end:'12:00', title:'âœˆï¸ æ¡ƒæ©Ÿå ±åˆ°', type:'move', cost:0, desc:'T1 è™èˆªæ«ƒæª¯ï¼Œè¨˜å¾—ç·šä¸Šå ±åˆ°', advice:'å…ˆåƒæ¼¢å ¡ç‹å¢Šèƒƒ'},
                {id:'e2', start:'12:00', end:'15:00', title:'IT750 é£›è¡Œ', type:'move', cost:0, desc:'PNR: B8453T'},
                {id:'e3', start:'16:00', end:'17:00', title:'ğŸšŒ ç©ºæ¸¯å·´å£«', type:'move', cost:1600, desc:'å¾€åˆ¥åºœåŒ—æµœ', advice:'åå·¦é‚Šçœ‹æµ·ï¼'},
                {id:'e4', start:'17:30', end:'19:30', title:'ğŸ¥© ç‡’è‚‰ä¸€åŠ›', type:'food', cost:5000, desc:'åœ¨åœ°è€åº—ï¼Œç…™å‘³é‡ä½†å¥½åƒ', img:IMG_BEEF},
                {id:'e6', start:'21:00', end:'23:59', title:'ğŸ¨ è¥¿é‰„ãƒªã‚¾ãƒ¼ãƒˆã‚¤ãƒ³', type:'stay', cost:0, desc:'æ³¡æ¹¯ (é–‹æ”¾è‡³01:00)'}
            ],
            d2: [
                {id:'e1', start:'09:00', end:'11:30', title:'ğŸš  é¶´è¦‹å²³çºœè»Š', type:'spot', cost:1600, desc:'å±±ä¸Šé›¶åº¦ï¼Œå¿…çœ‹ LiveCam', img:IMG_ROPEWAY, planb:'æµ·åœ°ç„'},
                {id:'e2', start:'11:30', end:'13:00', title:'ğŸ¤ ã¨ã‚ˆå¸¸ å¤©ä¸¼', type:'food', cost:1200, desc:'åˆé¤ï¼Œå»ºè­°11:00æ’éšŠ'},
                {id:'e3', start:'15:00', end:'17:00', title:'ğŸ¨ JR Blossom', type:'stay', cost:0, desc:'City Spa æ—¥è½æº«æ³‰'}
            ],
            d3: [
                {id:'e1', start:'10:00', end:'11:00', title:'ğŸš‚ ç§»å‹•å¾€ç”±å¸ƒé™¢', type:'move', cost:1100, desc:'JR ä¹…å¤§æœ¬ç·š'},
                {id:'e2', start:'11:00', end:'14:00', title:'ğŸ“· æ¹¯ä¹‹åªè¡—é“', type:'spot', cost:2000, desc:'é‚Šåƒé‚Šé€›', img:IMG_YUFUIN},
                {id:'e3', start:'16:00', end:'18:00', title:'ğŸ¨ ã‚«ãƒ³ãƒˆãƒªãƒ¼ã‚¤ãƒ³éº“èˆ', type:'stay', cost:0, desc:'Check-inï¼Œæ™šé¤è±ç››'}
            ]
        },
        expert: {
            d1: "ğŸ’¡ æ©Ÿå ´å·´å£«è‹¥äººå¤šè¦æ’åŠ ç­è»Šï¼Œå‹•ä½œè¦å¿«ã€‚",
            d2: "ğŸ’¡ City Spa é ‚æ¨“é¢¨å¤§ï¼Œå†¬å¤©æ³¡æ¹¯é ­è¦åŒ…æ¯›å·¾ä¿æš–ã€‚",
            d3: "ğŸ’¡ éº“èˆæ™šé¤å¾ˆå¤šï¼Œä¸­åˆåˆ¥åƒå¤ªæ’ã€‚"
        }
    };

    let appData = {};
    let currentMobileDay = 1;
    let currentEvId = null;
    let currentDayId = null;
    let currentFilter = 'all';

    // --- Init ---
    function init() {
        const saved = localStorage.getItem(STORAGE_KEY);
        appData = saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(defaultData));
        daysMeta.forEach(d => { if(!appData.events['d'+d.id]) appData.events['d'+d.id] = []; });
        renderMobile();
        renderDesktopTable();
        renderDB();
        renderRefTables();
    }

    // --- Mobile Rendering ---
    function renderMobile() {
        const selector = document.getElementById('m-day-selector');
        selector.innerHTML = '';
        daysMeta.forEach(d => {
            const isActive = d.id === currentMobileDay ? 'active' : '';
            selector.innerHTML += `<div class="m-day-btn ${isActive}" onclick="setMobileDay(${d.id})"><div class="m-day-num">${d.date.split('/')[1].split(' ')[0]}</div><div class="m-day-txt">${d.w}</div></div>`;
        });

        const advice = appData.expert['d'+currentMobileDay] || "äº«å—æ—…ç¨‹ï¼Œæ³¨æ„å®‰å…¨ï¼";
        document.getElementById('m-daily-advice').innerHTML = advice;

        const list = document.getElementById('m-timeline-list');
        list.innerHTML = '<div class="m-timeline-line"></div>';
        
        const events = appData.events['d'+currentMobileDay] || [];
        events.sort((a,b) => a.start.localeCompare(b.start));

        if (events.length === 0) {
            list.innerHTML += `<div style="text-align:center; padding:40px; color:var(--text-sub);">æœ¬æ—¥å°šç„¡è¡Œç¨‹<br><button class="btn" style="margin-top:10px;" onclick="openEditor(${currentMobileDay})">+ æ–°å¢</button></div>`;
            return;
        }

        events.forEach(ev => {
            let icon = 'circle';
            if(ev.type==='move') icon='directions_bus';
            if(ev.type==='food') icon='restaurant';
            if(ev.type==='spot') icon='photo_camera';
            if(ev.type==='stay') icon='hotel';
            
            let imgHtml = '';
            if(ev.img) imgHtml = `<div class="m-card-img has-img" style="background-image:url('${ev.img}')"><div class="m-img-badge">ç›¸ç‰‡</div></div>`;

            let warningHtml = '';
            if(ev.title.includes('ç§»å‹•') || ev.type === 'move') warningHtml = `<div class="tag-transport-warning"><span class="material-symbols-rounded" style="font-size:12px;">warning</span> è½‰ä¹˜æ³¨æ„</div>`;
            
            const typeClass = `type-${ev.type}`;

            list.innerHTML += `
            <div class="m-event-item ${typeClass}">
                <div class="m-event-icon-box"><span class="material-symbols-rounded" style="font-size:14px;">${icon}</span></div>
                <div class="m-event-card" onclick="openDrawer('${ev.id}', ${currentMobileDay})">
                    ${imgHtml}
                    <div class="m-card-body">
                        <div class="m-card-header"><div class="m-time-badge">${ev.start} - ${ev.end}</div>${ev.planb ? '<span class="tag" style="background:#e2e8f0;color:#64748b">å‚™æ¡ˆ</span>' : ''}</div>
                        <div class="m-card-title">${ev.title}</div>
                        <div class="m-card-desc">${ev.desc}</div>
                        ${warningHtml}
                        <div class="m-card-footer"><div class="m-cost ${ev.paid?'paid':''}">${ev.paid ? '<span class="material-symbols-rounded" style="font-size:14px">check_circle</span>' : ''} Â¥${ev.cost}</div></div>
                    </div>
                </div>
            </div>`;
        });
        list.innerHTML += `<button class="btn" style="width:100%; justify-content:center; margin-top:10px;" onclick="openEditor(${currentMobileDay})">+ æ–°å¢è¡Œç¨‹</button>`;
    }

    function setMobileDay(id) { currentMobileDay = id; renderMobile(); }

    // --- Desktop Render ---
    function renderDesktopTable() {
        const head = document.getElementById('d-header-row');
        const body = document.getElementById('d-body-row');
        head.innerHTML = '<th>é …ç›®</th>';
        let bodyHtml = '<tr><td style="padding:20px; vertical-align:top;"><strong>æ™‚é–“è»¸</strong></td>';
        daysMeta.forEach(d => { head.innerHTML += `<th>${d.date}<br><span class="text-sm">${d.city}</span></th>`; });
        daysMeta.forEach(d => {
            bodyHtml += `<td style="height:600px; position:relative; background:repeating-linear-gradient(white 0 59px, #f1f5f9 60px); padding:0; vertical-align:top;"><div style="height:100%; width:100%;" onclick="openEditor(${d.id})">`;
            const events = appData.events['d'+d.id] || [];
            events.forEach(ev => {
                const [sh, sm] = ev.start.split(':').map(Number);
                const [eh, em] = ev.end.split(':').map(Number);
                const startMin = (sh - 6) * 60 + sm;
                const duration = ((eh - sh) * 60) + (em - sm);
                const top = startMin * 0.8;
                const height = Math.max(40, duration * 0.8);
                bodyHtml += `<div class="event-block type-${ev.type} d-block" style="top:${top}px; height:${height}px; left:4px; right:4px;" onclick="event.stopPropagation(); openDrawer('${ev.id}', ${d.id})">
                    <div style="font-size:10px; font-weight:bold;">${ev.start}</div><div style="font-weight:bold; overflow:hidden;">${ev.title}</div></div>`;
            });
            bodyHtml += `</div></td>`;
        });
        bodyHtml += '</tr>';
        body.innerHTML = bodyHtml;
    }

    // --- Database Render ---
    function renderDB(filter = '') {
        const tbody = document.getElementById('db-tbody');
        tbody.innerHTML = '';
        daysMeta.forEach(d => {
            const events = appData.events['d'+d.id] || [];
            events.forEach(ev => {
                if (currentFilter !== 'all' && ev.type !== currentFilter) return;
                if (filter && !ev.title.includes(filter) && !ev.desc.includes(filter)) return;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><span style="font-weight:600">${d.date}</span></td>
                    <td class="font-mono">${ev.start} - ${ev.end}</td>
                    <td><span class="tag-type ${ev.type}">${ev.type}</span></td>
                    <td style="font-weight:600">${ev.title}</td>
                    <td>${ev.desc}</td>
                    <td class="font-mono">Â¥${ev.cost}</td>
                    <td><button class="btn" style="padding:4px 8px;" onclick="openEditor(${d.id}, '${ev.id}')">ç·¨è¼¯</button></td>
                `;
                tbody.appendChild(tr);
            });
        });
    }

    function filterDb(type) {
        currentFilter = type;
        document.querySelectorAll('.db-filter').forEach(b => b.classList.remove('active'));
        document.querySelector(`.db-filter[onclick="filterDb('${type}')"]`).classList.add('active');
        renderDB();
    }

    function renderRefTables() {
        const spotTbody = document.getElementById('ref-spot-tbody');
        spotTbody.innerHTML = '';
        Object.keys(spotDB).forEach(key => {
            spotTbody.innerHTML += `<tr><td><strong>${key}</strong></td><td>${spotDB[key].open || '-'}</td><td>${spotDB[key].tips || '-'}</td></tr>`;
        });
        const expTbody = document.getElementById('ref-expert-tbody');
        expTbody.innerHTML = '';
        daysMeta.forEach(d => {
            expTbody.innerHTML += `<tr><td><strong>${d.date}</strong></td><td>${appData.expert['d'+d.id] || '-'}</td></tr>`;
        });
    }

    // --- Drawer & Editor ---
    function openDrawer(evId, dayId) {
        currentEvId = evId; currentDayId = dayId;
        const ev = appData.events['d'+dayId].find(e => e.id === evId);
        if(!ev) return;
        document.getElementById('d-drawer-title').innerText = ev.title;
        document.getElementById('d-drawer-type').innerText = ev.type.toUpperCase();
        document.getElementById('d-drawer-time').innerText = `${ev.start} - ${ev.end}`;
        document.getElementById('d-drawer-cost').innerText = `Â¥${ev.cost} ${ev.paid?'(å·²ä»˜)':''}`;
        document.getElementById('d-drawer-desc').innerText = ev.desc || '-';
        document.getElementById('d-drawer-advice').innerText = appData.expert['d'+dayId] || 'æš«ç„¡å»ºè­°';
        
        const imgCont = document.getElementById('d-drawer-img-container');
        if(ev.img) { imgCont.style.display = 'block'; document.getElementById('d-drawer-img').src = ev.img; } else { imgCont.style.display = 'none'; }
        
        const pb = document.getElementById('d-drawer-planb');
        if(ev.planb) { pb.style.display = 'block'; document.getElementById('d-drawer-planb-text').innerText = ev.planb; } else { pb.style.display = 'none'; }

        document.getElementById('drawer-backdrop').style.opacity = '1';
        document.getElementById('drawer-backdrop').style.pointerEvents = 'auto';
        document.getElementById('detail-drawer').classList.add('active');
    }
    
    function closeDrawer() {
        document.getElementById('drawer-backdrop').style.opacity = '0';
        document.getElementById('drawer-backdrop').style.pointerEvents = 'none';
        document.getElementById('detail-drawer').classList.remove('active');
    }

    function openEditor(dayId, evId=null) {
        currentDayId = dayId; currentEvId = evId;
        const modal = document.getElementById('editor-overlay');
        modal.style.display = 'flex';
        // Reset
        document.getElementById('e-start').value = '10:00'; document.getElementById('e-end').value = '11:00';
        document.getElementById('e-title').value = ''; document.getElementById('e-cost').value = '';
        document.getElementById('e-desc').value = ''; document.getElementById('e-img').value = ''; document.getElementById('e-planb').value = '';
        if(evId) {
             const ev = appData.events['d'+dayId].find(e => e.id === evId);
             document.getElementById('e-start').value = ev.start; document.getElementById('e-end').value = ev.end;
             document.getElementById('e-title').value = ev.title; document.getElementById('e-cost').value = ev.cost;
             document.getElementById('e-desc').value = ev.desc; document.getElementById('e-img').value = ev.img || '';
             document.getElementById('e-planb').value = ev.planb || '';
        }
    }
    function closeEditor() { document.getElementById('editor-overlay').style.display = 'none'; }
    
    function saveEvent() {
        const title = document.getElementById('e-title').value;
        if(!title) return alert('è«‹è¼¸å…¥åç¨±');
        const newEv = {
            id: currentEvId || 'e'+Date.now(),
            start: document.getElementById('e-start').value, end: document.getElementById('e-end').value,
            title: title, type: document.getElementById('e-type').value,
            cost: document.getElementById('e-cost').value, desc: document.getElementById('e-desc').value,
            img: document.getElementById('e-img').value, planb: document.getElementById('e-planb').value
        };
        if(!appData.events['d'+currentDayId]) appData.events['d'+currentDayId] = [];
        if(currentEvId) {
            const idx = appData.events['d'+currentDayId].findIndex(e=>e.id===currentEvId);
            appData.events['d'+currentDayId][idx] = newEv;
        } else { appData.events['d'+currentDayId].push(newEv); }
        localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
        closeEditor(); renderMobile(); renderDesktopTable(); renderDB();
    }
    function deleteEvent() {
        if(confirm('åˆªé™¤ï¼Ÿ')) {
            appData.events['d'+currentDayId] = appData.events['d'+currentDayId].filter(e=>e.id!==currentEvId);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
            closeDrawer(); renderMobile(); renderDesktopTable(); renderDB();
        }
    }
    function openMap() { window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(document.getElementById('d-drawer-title').innerText)}`, '_blank'); }

    // --- Navigation ---
    function switchTab(tab) {
        document.getElementById('portal').classList.add('hidden');
        document.getElementById('mobile-view').style.display = 'none';
        document.getElementById('desktop-view').style.display = 'none';
        document.getElementById('db-view').style.display = 'none';
        
        document.getElementById(tab+'-view').style.display = 'block';
        
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        if(tab === 'mobile') document.querySelectorAll('.nav-item')[0].classList.add('active');
        if(tab === 'desktop') document.querySelectorAll('.nav-item')[1].classList.add('active');
        if(tab === 'db') document.querySelectorAll('.nav-item')[2].classList.add('active');
    }
    
    function exportData() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData));
        const node = document.createElement('a'); node.setAttribute("href", dataStr);
        node.setAttribute("download", "kyushu_plan_v21.json");
        document.body.appendChild(node); node.click(); node.remove();
    }
    function importData() { document.getElementById('import-file').click(); }
    function processImport(input) {
        const file = input.files[0]; const reader = new FileReader();
        reader.onload = (e) => { appData = JSON.parse(e.target.result); localStorage.setItem(STORAGE_KEY, JSON.stringify(appData)); location.reload(); };
        reader.readAsText(file);
    }

    init();
  </script>
</body>
</html>
