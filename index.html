<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>2025 ä¹å·æ—…è¡ŒæŒ‡æ®ä¸­å¿ƒ V19</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <!-- Google Fonts & Icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+TC:wght@400;500;700;900&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary: #0f172a; --primary-light: #334155;
      --accent: #3b82f6; 
      --bg-body: #f8fafc; --bg-surface: #ffffff;
      --text-main: #1e293b; --text-sub: #64748b; 
      --border: #e2e8f0;
      
      /* Functional Colors */
      --color-transport: #0ea5e9; 
      --color-food: #f97316;      
      --color-spot: #10b981;      
      --color-stay: #8b5cf6;      

      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-card: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-float: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { 
        font-family: 'Inter', 'Noto Sans TC', sans-serif; 
        background: var(--bg-body); margin: 0; 
        color: var(--text-main); line-height: 1.5; 
        padding-bottom: 80px; 
        overflow-x: hidden; transition: padding-left 0.3s ease; 
    }

    /* --- Components --- */
    .btn { padding: 8px 16px; border-radius: 10px; border: 1px solid var(--border); background: white; cursor: pointer; font-size: 13px; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; transition: all 0.2s; color: var(--text-main); }
    .btn:hover { background: #f1f5f9; transform: translateY(-1px); }
    .btn-primary { background: var(--text-main); color: white; border: none; box-shadow: 0 4px 12px rgba(15, 23, 42, 0.2); }
    .btn-primary:hover { background: #334155; }
    .btn-danger { color: #ef4444; border-color: #fee2e2; background: #fef2f2; }
    
    .tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 700; display: inline-flex; align-items: center; gap: 3px; }
    
    /* --- Portal --- */
    #portal { position: fixed; inset: 0; background: radial-gradient(circle at top right, #1e293b, #0f172a); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; transition: opacity 0.5s; }
    #portal.hidden { opacity: 0; pointer-events: none; }
    .portal-cards { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }
    .portal-card { background: rgba(255,255,255,0.05); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; padding: 40px; width: 200px; cursor: pointer; text-align: center; transition: transform 0.3s; display: inline-flex; flex-direction: column; align-items: center; gap: 16px; margin: 10px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
    .portal-card:hover { transform: translateY(-8px); background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.3); }
    .portal-card span { font-size: 40px; }

    /* --- Bottom Navigation --- */
    .bottom-nav {
        position: fixed; bottom: 0; left: 0; width: 100%;
        background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
        border-top: 1px solid var(--border);
        display: none; justify-content: space-around; padding: 8px 0;
        z-index: 1000; padding-bottom: env(safe-area-inset-bottom);
    }
    .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 10px; color: var(--text-sub); background: none; border: none; cursor: pointer; gap: 4px; width: 25%; }
    .nav-item.active { color: var(--accent); font-weight: 600; }
    .nav-item span { font-size: 24px; transition: transform 0.2s; }
    .nav-item.active span { transform: translateY(-2px); }
    @media (max-width: 768px) { .bottom-nav { display: flex; } }

    /* --- Detail Drawer --- */
    .drawer-backdrop { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.2); backdrop-filter: blur(2px); z-index: 1999; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
    .drawer-backdrop.active { opacity: 1; pointer-events: auto; }
    
    .detail-drawer {
        position: fixed; top: 0; left: 0; bottom: 0; width: 420px; max-width: 90vw;
        background: white; z-index: 2000;
        box-shadow: 20px 0 50px rgba(0,0,0,0.1);
        transform: translateX(-100%);
        transition: transform 0.35s cubic-bezier(0.16, 1, 0.3, 1);
        display: flex; flex-direction: column; border-right: 1px solid var(--border);
    }
    .detail-drawer.active { transform: translateX(0); }
    
    body.drawer-pinned { padding-left: 420px; }
    body.drawer-pinned .drawer-backdrop { display: none; }
    body.drawer-pinned .detail-drawer { box-shadow: none; border-right: 1px solid var(--border); }
    @media (max-width: 1024px) { body.drawer-pinned { padding-left: 0; } } 

    .drawer-header { padding: 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: flex-start; background: #f8fafc; }
    .drawer-body { flex: 1; overflow-y: auto; padding: 24px; }
    .drawer-footer { padding: 16px 24px; border-top: 1px solid var(--border); background: white; display: flex; justify-content: space-between; align-items: center; }

    /* Todo List Styles */
    .drawer-todo-list { margin-bottom: 24px; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
    .drawer-todo-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-bottom: 1px solid var(--border); background: white; cursor: pointer; transition: background 0.2s; }
    .drawer-todo-item:last-child { border-bottom: none; }
    .drawer-todo-item:hover { background: #f8fafc; }
    .drawer-todo-text { font-size: 14px; color: var(--text-main); flex: 1; }
    .drawer-todo-text.done { text-decoration: line-through; color: var(--text-sub); }
    .todo-checkbox { width: 18px; height: 18px; accent-color: var(--color-spot); cursor: pointer; }

    /* --- Desktop View --- */
    #desktop-view { display: none; max-width: 100%; margin: 0 auto; padding: 24px; animation: fadeIn 0.5s; }
    #desktop-view.active { display: block; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; background: white; padding: 16px 24px; border-radius: 16px; border: 1px solid var(--border); box-shadow: var(--shadow-sm); position: sticky; top: 10px; z-index: 90; }
    
    .dashboard-stats { display: flex; gap: 24px; align-items: center; }
    .stat-item { display: flex; flex-direction: column; }
    .stat-label { font-size: 11px; color: var(--text-sub); font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-val { font-size: 20px; font-weight: 800; color: var(--text-main); font-family: 'JetBrains Mono', monospace; }
    .stat-sub { font-size: 12px; color: var(--text-sub); }
    .stat-val.pending { color: #ef4444; }

    /* --- Visual Timeline --- */
    .main-table-wrapper { overflow-x: auto; background: white; border-radius: 20px; border: 1px solid var(--border); box-shadow: var(--shadow-card); }
    table { width: 100%; min-width: 1800px; border-collapse: separate; border-spacing: 0; }
    th { position: sticky; top: 0; background: #f8fafc; z-index: 20; padding: 16px; border-bottom: 1px solid var(--border); text-align: left; color: var(--text-sub); font-size: 13px; }
    td { padding: 0; border-right: 1px dashed var(--border); vertical-align: top; width: 11.11%; min-width: 200px; position: relative; transition: background 0.2s; }
    td:hover { background: #fcfcfc; }
    
    .timeline-container {
        position: relative;
        height: 1200px; 
        background-image: linear-gradient(to bottom, var(--border) 1px, transparent 1px);
        background-size: 100% 60px; 
        background-position: 0 20px;
    }
    .time-marker { position: absolute; left: 6px; font-size: 10px; color: #cbd5e1; width: 30px; pointer-events: none; font-family: 'JetBrains Mono'; }
    
    .event-block {
        position: absolute; left: 40px; right: 8px;
        border-radius: 12px; padding: 8px 10px;
        font-size: 12px; cursor: pointer;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
        display: flex; flex-direction: column; justify-content: center;
        background-size: cover; background-position: center;
        overflow: hidden; border: 1px solid rgba(0,0,0,0.05);
    }
    .event-block:hover { transform: scale(1.03) translateY(-2px); z-index: 50; box-shadow: 0 12px 24px rgba(0,0,0,0.15); }
    .event-block::before { content: ''; position: absolute; inset: 0; background: linear-gradient(to bottom, rgba(255,255,255,0.95), rgba(255,255,255,0.85)); z-index: 0; transition: opacity 0.2s; }
    .event-block:hover::before { opacity: 0.95; }
    
    .ev-content { position: relative; z-index: 1; display: flex; flex-direction: column; height: 100%; }
    .ev-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2px; }
    .ev-time { font-size: 10px; font-weight: 700; opacity: 0.6; font-family: 'JetBrains Mono'; }
    .ev-title { font-weight: 700; font-size: 13px; line-height: 1.3; color: var(--text-main); margin-bottom: 2px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .ev-bottom-row { display: flex; gap: 4px; margin-top: auto; flex-wrap: wrap; }
    .ev-badge { font-size: 9px; padding: 1px 4px; border-radius: 4px; background: rgba(0,0,0,0.05); color: var(--text-sub); }
    
    .ev-todo-badge {
        font-size: 9px; font-weight: 700;
        background: #dcfce7; color: #166534;
        padding: 1px 5px; border-radius: 4px;
        display: inline-flex; align-items: center; gap: 2px;
        border: 1px solid #bbf7d0;
    }

    .type-move { background-color: #f0f9ff; border-left: 4px solid var(--color-transport); border-radius: 8px; border: 1px dashed #bae6fd; border-left: 4px solid var(--color-transport); }
    .type-food { border-left: 4px solid var(--color-food); background-color: #fff7ed; }
    .type-spot { border-left: 4px solid var(--color-spot); background-color: #f0fdf4; }
    .type-stay { border-left: 4px solid var(--color-stay); background-color: #f5f3ff; }

    /* --- DB & Mobile --- */
    #db-view, #mobile-view { display: none; padding: 20px; animation: fadeIn 0.5s; max-width: 800px; margin: 0 auto; }
    #db-view.active, #mobile-view.active { display: block; }
    
    .m-event-card { background: white; border: 1px solid var(--border); border-radius: 16px; padding: 16px; margin-bottom: 16px; display: flex; gap: 16px; align-items: center; box-shadow: var(--shadow-sm); }
    .m-time-box { display: flex; flex-direction: column; align-items: center; min-width: 50px; font-family: 'JetBrains Mono'; font-size: 12px; color: var(--text-sub); font-weight: 600; }
    .m-line { width: 2px; flex-grow: 1; background: var(--border); margin: 4px 0; }
    
    /* Editor Modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2100; display: none; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
    .modal-overlay.active { display: flex; }
    .editor-modal { background: white; width: 90%; max-width: 450px; border-radius: 24px; padding: 24px; box-shadow: var(--shadow-float); animation: slideUp 0.3s; max-height: 90vh; overflow-y: auto; }

    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 11px; font-weight: 700; color: var(--text-sub); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
    .form-input { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; outline: none; transition: border-color 0.2s; font-family: inherit; }
    .form-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    
    .checkbox-wrapper { display: flex; align-items: center; gap: 8px; margin-top: 6px; cursor: pointer; user-select: none; }
    .checkbox-input { width: 18px; height: 18px; accent-color: var(--color-spot); cursor: pointer; }
    
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  </style>
</head>
<body>

  <!-- 0. Portal -->
  <div id="portal">
    <h1 style="font-size:32px; font-weight:800; margin-bottom:8px;">2025 ä¹å·æŒ‡æ®ä¸­å¿ƒ V19</h1>
    <div style="font-size:14px; opacity:0.7; margin-bottom:40px;">å®Œæ•´å…¥å£ä¿®å¾©ç‰ˆï¼šæ‰€æœ‰å…¥å£åŠŸèƒ½å›æ­¸</div>
    
    <div class="portal-cards">
        <div class="portal-card" onclick="switchTab('desktop')">
            <span class="material-symbols-rounded">view_timeline</span>
            <div style="font-weight:700;">æˆ°ç•¥è¦–åœ– (Desktop)</div>
        </div>
        <div class="portal-card" onclick="switchTab('mobile')">
            <span class="material-symbols-rounded">smartphone</span>
            <div style="font-weight:700;">éš¨è¡Œæ¨¡å¼ (Mobile)</div>
        </div>
        <div class="portal-card" onclick="switchTab('db')">
            <span class="material-symbols-rounded">table_rows</span>
            <div style="font-weight:700;">è³‡æ–™åº« (Database)</div>
        </div>
    </div>
  </div>

  <!-- 1. Detail Drawer -->
  <div class="drawer-backdrop" id="drawer-backdrop" onclick="closeDrawer()"></div>
  <div class="detail-drawer" id="detail-drawer">
    <div class="drawer-header">
        <div style="flex:1">
            <div id="d-badge" style="font-size:10px; font-weight:700; color:var(--text-sub); text-transform:uppercase; margin-bottom:4px;">TYPE</div>
            <div id="d-title" style="font-size:20px; font-weight:800; line-height:1.2;">Title</div>
        </div>
        <div style="display:flex; gap:4px;">
            <button class="btn" style="padding:6px;" onclick="togglePin()" title="å›ºå®š"><span class="material-symbols-rounded" style="font-size:18px;">push_pin</span></button>
            <button class="btn" style="padding:6px;" onclick="closeDrawer()" title="é—œé–‰"><span class="material-symbols-rounded" style="font-size:18px;">close</span></button>
        </div>
    </div>
    <div class="drawer-body">
        <!-- Todo List Section -->
        <div id="d-todo-container" style="margin-bottom:24px;">
            <div style="font-size:11px; font-weight:700; color:var(--text-sub); margin-bottom:8px; text-transform:uppercase;">ğŸ“‹ å¾…è¾¦äº‹é … (é»æ“Šåˆ‡æ›å®Œæˆ)</div>
            <div class="drawer-todo-list" id="d-todo-list"></div>
        </div>

        <!-- Plan B Toggle -->
        <div id="d-plan-b-alert" style="display:none; background:#f1f5f9; border-radius:12px; padding:12px; margin-bottom:20px; border:1px dashed var(--text-sub);">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="font-weight:600; font-size:13px; display:flex; align-items:center; gap:6px;"><span class="material-symbols-rounded">rainy</span> å‚™æ¡ˆè¡Œç¨‹å¯ç”¨</span>
                <button class="btn" style="font-size:11px; padding:4px 10px;" onclick="togglePlanBView()">åˆ‡æ›æŸ¥çœ‹</button>
            </div>
            <div id="d-plan-b-text" style="margin-top:8px; font-size:13px; color:var(--text-sub); display:none;"></div>
        </div>

        <div class="form-grid">
            <div><div class="info-label">æ™‚é–“</div><div id="d-time" style="font-weight:600;"></div></div>
            <div><div class="info-label">é ç®—</div><div id="d-cost" style="font-weight:600;"></div></div>
        </div>
        <div style="margin-top:20px;">
             <div class="info-label">è©³ç´°èªªæ˜ & æ”»ç•¥</div>
             <div id="d-desc" style="font-size:14px; line-height:1.6; color:var(--text-main);"></div>
        </div>
        <div style="margin-top:20px; padding:16px; background:#f0f9ff; border-radius:12px; border:1px solid #bae6fd;">
             <div style="font-size:11px; font-weight:700; color:#0284c7; margin-bottom:6px; text-transform:uppercase;">ğŸ‘¨â€ğŸ« è€å¸«å‚…å»ºè­°</div>
             <div id="d-advice" style="font-size:13px; color:#0c4a6e;"></div>
        </div>
    </div>
    <div class="drawer-footer">
        <button class="btn btn-danger" onclick="deleteEvent()">åˆªé™¤</button>
        <button class="btn btn-primary" onclick="openEditor()">ç·¨è¼¯ / å¾…è¾¦</button>
    </div>
  </div>

  <!-- 2. Desktop View -->
  <div id="desktop-view">
    <div class="header">
      <div class="title">
          <div style="font-size:11px; font-weight:700; color:var(--text-sub);">KYUSHU 2025</div>
          <h1>è¡Œç¨‹æˆ°ç•¥åœ–</h1>
      </div>
      <div class="dashboard-stats">
          <div class="stat-item">
              <div class="stat-label">ç¸½é ç®— (æ¯äºº)</div>
              <div class="stat-val" id="dash-total">Â¥0</div>
          </div>
          <div class="stat-item">
              <div class="stat-label">å°šæœªæ”¯ä»˜</div>
              <div class="stat-val pending" id="dash-pending">Â¥0</div>
              <div class="stat-sub">ç¾é‡‘/ç¾å ´åˆ·å¡</div>
          </div>
      </div>
      <div style="display:flex; gap:8px;">
         <button class="btn" onclick="switchTab('mobile')"><span class="material-symbols-rounded">smartphone</span> æ‰‹æ©Ÿç‰ˆ</button>
         <button class="btn" onclick="switchTab('db')"><span class="material-symbols-rounded">table_rows</span> è³‡æ–™åº«</button>
         <button class="btn" onclick="exportData()"><span class="material-symbols-rounded">download</span> å‚™ä»½</button>
         <button class="btn" onclick="importData()"><span class="material-symbols-rounded">upload</span> é‚„åŸ</button>
         <input type="file" id="import-file" style="display:none" onchange="processImport(this)">
      </div>
    </div>

    <div class="main-table-wrapper">
      <table id="timeline-table">
        <thead><tr id="header-row"></tr></thead>
        <tbody>
           <tr id="timeline-row"></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- 3. Mobile View -->
  <div id="mobile-view">
      <div style="padding:20px;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
              <div>
                  <h2 style="font-size:24px; margin-bottom:4px;">æˆ‘çš„è¡Œç¨‹</h2>
                  <div style="font-size:13px; color:var(--text-sub);">2025.12.10 - 12.18</div>
              </div>
              <button class="btn" onclick="switchTab('desktop')">é›»è…¦ç‰ˆ</button>
          </div>
          <div id="m-list"></div>
      </div>
  </div>

  <!-- 4. Database View -->
  <div id="db-view">
      <div style="padding:20px; max-width:900px; margin:0 auto;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
              <h2>è³‡æ–™åº«</h2>
              <button class="btn" onclick="switchTab('desktop')">è¿”å›åœ–è¡¨</button>
          </div>
          <input type="text" class="form-input" placeholder="æœå°‹è¡Œç¨‹..." onkeyup="renderDB(this.value)">
          <div id="db-list" style="margin-top:20px;"></div>
      </div>
  </div>

  <!-- Bottom Nav -->
  <div class="bottom-nav">
      <button class="nav-item active" onclick="switchTab('desktop')"><span class="material-symbols-rounded">calendar_view_day</span>è¡Œç¨‹è¡¨</button>
      <button class="nav-item" onclick="switchTab('mobile')"><span class="material-symbols-rounded">view_agenda</span>å¡ç‰‡</button>
      <button class="nav-item" onclick="switchTab('db')"><span class="material-symbols-rounded">table_rows</span>è³‡æ–™åº«</button>
      <button class="nav-item" onclick="exportData()"><span class="material-symbols-rounded">save</span>å‚™ä»½</button>
  </div>

  <!-- Editor Modal -->
  <div class="modal-overlay" id="editor-modal">
    <div class="editor-modal">
      <h3 style="margin-top:0;">ç·¨è¼¯è¡Œç¨‹</h3>
      
      <div class="form-grid">
          <div class="form-group">
              <label class="form-label">é–‹å§‹æ™‚é–“</label>
              <input type="time" class="form-input" id="e-start">
          </div>
          <div class="form-group">
              <label class="form-label">çµæŸæ™‚é–“</label>
              <input type="time" class="form-input" id="e-end">
          </div>
      </div>

      <div class="form-group">
          <label class="form-label">åç¨±</label>
          <input type="text" class="form-input" id="e-title">
      </div>

      <div class="form-grid">
          <div class="form-group">
              <label class="form-label">é¡å‹</label>
              <select class="form-input" id="e-type">
                  <option value="move">ğŸšŒ äº¤é€šç§»å‹•</option>
                  <option value="food">ğŸ± é¤é£²ç¾é£Ÿ</option>
                  <option value="spot">ğŸ“· æ™¯é»è§€å…‰</option>
                  <option value="stay">ğŸ¨ ä½å®¿ä¼‘æ¯</option>
              </select>
          </div>
          <div class="form-group">
              <label class="form-label">é ç®— (JPY)</label>
              <input type="number" class="form-input" id="e-cost" placeholder="0">
              <label class="checkbox-wrapper">
                  <input type="checkbox" class="checkbox-input" id="e-paid">
                  <span style="font-size:12px;">å·²ä»˜æ¬¾</span>
              </label>
          </div>
      </div>

      <div class="form-group">
          <label class="form-label">å¾…è¾¦äº‹é … (ä¸€è¡Œä¸€å€‹ï¼Œä¾‹å¦‚: ç·šä¸Šå ±åˆ°)</label>
          <textarea class="form-input" id="e-todos" rows="3" placeholder="è³¼è²·é–€ç¥¨&#10;é ç´„é¤å»³"></textarea>
      </div>

      <div class="form-group">
          <label class="form-label">è©³ç´°èªªæ˜</label>
          <textarea class="form-input" id="e-desc" rows="2"></textarea>
      </div>
      
      <div class="form-group">
          <label class="form-label">å‚™æ¡ˆè¡Œç¨‹</label>
          <input type="text" class="form-input" id="e-planb">
      </div>

      <div class="editor-actions">
          <button class="btn" onclick="closeEditor()">å–æ¶ˆ</button>
          <button class="btn btn-primary" onclick="saveEditor()">å„²å­˜</button>
      </div>
    </div>
  </div>

  <script>
    // --- Data & Config ---
    const STORAGE_KEY = 'kyushu_v19_fixed';
    const daysMeta = [
      {id:1, date:'12/10 (ä¸‰)', city:'åˆ¥åºœ'}, {id:2, date:'12/11 (å››)', city:'å¤§åˆ†'}, 
      {id:3, date:'12/12 (äº”)', city:'ç”±å¸ƒé™¢'}, {id:4, date:'12/13 (å…­)', city:'æµ®ç¾½'}, 
      {id:5, date:'12/14 (æ—¥)', city:'åŸé¶´'}, {id:6, date:'12/15 (ä¸€)', city:'åšå¤š'},
      {id:7, date:'12/16 (äºŒ)', city:'åŒ—ä¹å·'}, {id:8, date:'12/17 (ä¸‰)', city:'åšå¤š'}, 
      {id:9, date:'12/18 (å››)', city:'è¿”ç¨‹'}
    ];

    // Default Data
    const defaultData = {
        events: {
            d1: [
                {id:'e1', start:'10:00', end:'12:00', title:'âœˆï¸ æ¡ƒæ©Ÿå ±åˆ°', type:'move', cost:0, paid:true, desc:'T1 è™èˆªæ«ƒæª¯', todos:[{text:'ç·šä¸Šå ±åˆ°',done:false}, {text:'ä¸‹è¼‰ç™»æ©Ÿè­‰',done:false}]},
                {id:'e3', start:'16:00', end:'17:00', title:'ğŸšŒ ç©ºæ¸¯å·´å£«', type:'move', cost:1600, paid:false, desc:'å¾€åˆ¥åºœåŒ—æµœ', todos:[{text:'æº–å‚™é›¶éŒ¢',done:false}]},
                {id:'e4', start:'17:30', end:'19:30', title:'ğŸ¥© ç‡’è‚‰ä¸€åŠ›', type:'food', cost:5000, paid:false, desc:'åœ¨åœ°è€åº—', todos:[{text:'é›»è©±è¨‚ä½',done:false}]}
            ],
            d2: [
                {id:'e1', start:'09:00', end:'11:30', title:'ğŸš  é¶´è¦‹å²³çºœè»Š', type:'spot', cost:1600, paid:false, desc:'å±±ä¸Šé›¶åº¦', todos:[{text:'æŸ¥ Live Cam',done:false}]}
            ]
        }
    };

    let appData = {};
    let currentDay = null;
    let currentEvId = null;
    let isPinned = false;

    // --- Core Logic ---
    function init() {
        const saved = localStorage.getItem(STORAGE_KEY);
        appData = saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(defaultData));
        daysMeta.forEach(d => { if(!appData.events['d'+d.id]) appData.events['d'+d.id] = []; });
        renderAll();
    }

    function renderAll() {
        renderDesktop();
        renderMobile();
        renderDB();
        updateDashboard();
    }

    // --- Desktop Render ---
    function renderDesktop() {
        const hRow = document.getElementById('header-row');
        const tRow = document.getElementById('timeline-row');
        hRow.innerHTML = '<th></th>';
        tRow.innerHTML = `<td style="vertical-align:top; padding:20px; font-size:12px; color:var(--text-sub);">
            <strong>24H è¦–è¦ºè»¸</strong><br><br>
            <span style="color:var(--color-transport)">â– </span> äº¤é€š<br>
            <span style="color:var(--color-food)">â– </span> ç¾é£Ÿ<br>
            <span style="color:var(--color-spot)">â– </span> æ™¯é»<br>
            <span style="color:var(--color-stay)">â– </span> ä½å®¿
        </td>`;

        daysMeta.forEach(d => {
            hRow.innerHTML += `<th><div style="font-size:16px;font-weight:800;">${d.date}</div><div style="font-size:12px;">${d.city}</div><button class="btn" style="width:100%;margin-top:8px;justify-content:center;font-size:11px;" onclick="openEditor(${d.id})">+ æ–°å¢</button></th>`;
            
            let html = `<td class="day-col"><div class="timeline-container" onclick="openEditor(${d.id})">`;
            for(let h=6; h<24; h+=2) html += `<div class="time-marker" style="top:${(h-6)*60}px">${h}:00</div>`;
            
            const events = appData.events['d'+d.id] || [];
            events.forEach(ev => {
                const [sh, sm] = ev.start.split(':').map(Number);
                const [eh, em] = ev.end.split(':').map(Number);
                const startMin = (sh - 6) * 60 + sm;
                const duration = ((eh - sh) * 60) + (em - sm);
                const height = Math.max(30, duration);
                
                let extraClass = '';
                if (ev.type === 'move') extraClass = 'type-move';
                else if (ev.type === 'food') extraClass = 'type-food';
                else if (ev.type === 'spot') extraClass = 'type-spot';
                else extraClass = 'type-stay';

                const planBIcon = ev.planb ? `<span style="position:absolute;bottom:4px;right:4px;font-size:12px;">â˜”</span>` : '';
                const paidIcon = ev.paid ? `<span class="material-symbols-rounded" style="font-size:10px; color:green;">check_circle</span>` : '';
                
                let todoBadge = '';
                if (ev.todos && ev.todos.length > 0) {
                    const doneCount = ev.todos.filter(t => t.done).length;
                    const totalCount = ev.todos.length;
                    todoBadge = `<div class="ev-todo-badge"><span class="material-symbols-rounded" style="font-size:10px">check_box</span> ${doneCount}/${totalCount}</div>`;
                }

                html += `<div class="event-block ${extraClass}" style="top:${startMin}px; height:${height}px;" onclick="event.stopPropagation(); openDrawer('${ev.id}', ${d.id})">
                    <div class="ev-content">
                        <div class="ev-header"><span class="ev-time">${ev.start}</span> ${paidIcon}</div>
                        <div class="ev-title">${ev.title}</div>
                        <div class="ev-bottom-row">
                             <div class="ev-badge">Â¥${ev.cost}</div>
                             ${todoBadge}
                        </div>
                    </div>
                    ${planBIcon}
                </div>`;
            });
            
            html += `</div></td>`;
            tRow.innerHTML += html;
        });
    }

    // --- Mobile Render ---
    function renderMobile() {
        const c = document.getElementById('m-list');
        c.innerHTML = '';
        daysMeta.forEach(d => {
            const events = appData.events['d'+d.id] || [];
            events.sort((a,b)=>a.start.localeCompare(b.start));
            
            let html = `<div class="m-card" style="border-left:4px solid var(--primary);">
                <div style="font-weight:800; font-size:16px; margin-bottom:12px; display:flex; justify-content:space-between;">
                    <span>${d.date} ${d.city}</span>
                    <button class="btn" style="padding:4px 8px; font-size:11px;" onclick="openEditor(${d.id})">+</button>
                </div>`;
            
            events.forEach(ev => {
                let todoStr = '';
                if(ev.todos && ev.todos.length > 0) {
                    const done = ev.todos.filter(t=>t.done).length;
                    todoStr = `<span style="font-size:11px; background:#dcfce7; color:#166534; padding:2px 6px; border-radius:4px; margin-left:6px;">âœ… ${done}/${ev.todos.length}</span>`;
                }

                html += `<div class="m-event-row" onclick="openDrawer('${ev.id}', ${d.id})">
                    <div class="m-time-col">${ev.start}</div>
                    <div class="m-info-col">
                        <div class="m-title">${ev.title} ${ev.planb ? 'â˜”' : ''}</div>
                        <div class="m-desc">${ev.desc || ''} ${todoStr}</div>
                    </div>
                    <div style="font-size:12px; font-weight:600; color:${ev.paid?'#10b981':'#f97316'}">Â¥${ev.cost}</div>
                </div>`;
            });
            html += `</div>`;
            c.innerHTML += html;
        });
    }

    // --- DB Render ---
    function renderDB(filter = '') {
        const c = document.getElementById('db-list');
        c.innerHTML = '';
        daysMeta.forEach(d => {
            const events = appData.events['d'+d.id] || [];
            events.forEach(ev => {
                if(filter && !JSON.stringify(ev).toLowerCase().includes(filter.toLowerCase())) return;
                c.innerHTML += `<div class="m-card" style="padding:10px; font-size:13px;">
                    <span class="tag" style="background:#e2e8f0;">${d.date}</span> 
                    <span class="tag" style="background:#f1f5f9;">${ev.type}</span> 
                    <strong>${ev.title}</strong> - ${ev.desc}
                </div>`;
            });
        });
    }

    // --- Drawer & Editor ---
    function openDrawer(evId, dayId) {
        currentEvId = evId; currentDay = dayId;
        const ev = appData.events['d'+dayId].find(e=>e.id===evId);
        if(!ev) return;

        document.getElementById('d-title').innerText = ev.title;
        document.getElementById('d-badge').innerText = ev.type.toUpperCase();
        document.getElementById('d-time').innerText = `${ev.start} - ${ev.end}`;
        document.getElementById('d-cost').innerText = `Â¥${ev.cost} (${ev.paid ? 'å·²ä»˜' : 'æœªä»˜'})`;
        document.getElementById('d-desc').innerText = ev.desc || 'ç„¡å‚™è¨»';
        document.getElementById('d-advice').innerText = ev.advice || 'ç„¡ç‰¹æ®Šå»ºè­°';
        
        // Render Todo List
        const todoList = document.getElementById('d-todo-list');
        const todoContainer = document.getElementById('d-todo-container');
        todoList.innerHTML = '';
        if (ev.todos && ev.todos.length > 0) {
            todoContainer.style.display = 'block';
            ev.todos.forEach((task, index) => {
                todoList.innerHTML += `
                <div class="drawer-todo-item" onclick="toggleTodo('${evId}', ${dayId}, ${index})">
                    <input type="checkbox" class="todo-checkbox" ${task.done ? 'checked' : ''}>
                    <span class="drawer-todo-text ${task.done ? 'done' : ''}">${task.text}</span>
                </div>`;
            });
        } else {
            todoContainer.style.display = 'none';
        }

        const pbAlert = document.getElementById('d-plan-b-alert');
        const pbText = document.getElementById('d-plan-b-text');
        if(ev.planb) {
            pbAlert.style.display = 'block';
            pbText.innerText = ev.planb;
        } else {
            pbAlert.style.display = 'none';
        }
        pbText.style.display = 'none'; 

        if(!isPinned) document.getElementById('drawer-backdrop').classList.add('active');
        document.getElementById('detail-drawer').classList.add('active');
    }
    
    function toggleTodo(evId, dayId, index) {
        const ev = appData.events['d'+dayId].find(e=>e.id===evId);
        if(ev && ev.todos && ev.todos[index]) {
            ev.todos[index].done = !ev.todos[index].done;
            persist();
            renderAll();
            openDrawer(evId, dayId);
        }
    }

    function togglePlanBView() {
        const el = document.getElementById('d-plan-b-text');
        el.style.display = el.style.display === 'none' ? 'block' : 'none';
    }

    function closeDrawer() {
        document.getElementById('drawer-backdrop').classList.remove('active');
        document.getElementById('detail-drawer').classList.remove('active');
        if(isPinned) togglePin();
    }

    function togglePin() {
        isPinned = !isPinned;
        document.body.classList.toggle('drawer-pinned', isPinned);
    }

    function openEditor(dayId, evId=null) {
        currentDay = dayId; currentEvId = evId;
        document.getElementById('editor-modal').classList.add('active');
        
        if(evId) {
            // Load existing
            const ev = appData.events['d'+dayId].find(e=>e.id===evId);
            document.getElementById('e-start').value = ev.start;
            document.getElementById('e-end').value = ev.end;
            document.getElementById('e-title').value = ev.title;
            document.getElementById('e-cost').value = ev.cost;
            document.getElementById('e-type').value = ev.type;
            document.getElementById('e-paid').checked = ev.paid;
            document.getElementById('e-desc').value = ev.desc;
            document.getElementById('e-planb').value = ev.planb || '';
            const todoText = ev.todos ? ev.todos.map(t => t.text).join('\n') : '';
            document.getElementById('e-todos').value = todoText;
        } else {
            // New
            document.getElementById('e-start').value = '10:00';
            document.getElementById('e-end').value = '11:00';
            document.getElementById('e-title').value = '';
            document.getElementById('e-cost').value = '';
            document.getElementById('e-desc').value = '';
            document.getElementById('e-planb').value = '';
            document.getElementById('e-todos').value = '';
            document.getElementById('e-paid').checked = false;
        }
    }

    function saveEditor() {
        const title = document.getElementById('e-title').value;
        if(!title) return alert('è«‹è¼¸å…¥åç¨±');
        
        const todoRaw = document.getElementById('e-todos').value;
        const newTodoTexts = todoRaw.split('\n').map(t => t.trim()).filter(t => t !== '');
        
        let finalTodos = [];
        
        if(currentEvId) {
            const oldEv = appData.events['d'+currentDay].find(e=>e.id===currentEvId);
            finalTodos = newTodoTexts.map(text => {
                const existing = oldEv.todos ? oldEv.todos.find(t => t.text === text) : null;
                return existing ? existing : { text: text, done: false };
            });
        } else {
            finalTodos = newTodoTexts.map(text => ({ text: text, done: false }));
        }

        const newEv = {
            id: currentEvId || 'e'+Date.now(),
            start: document.getElementById('e-start').value,
            end: document.getElementById('e-end').value,
            title: title,
            type: document.getElementById('e-type').value,
            cost: parseInt(document.getElementById('e-cost').value) || 0,
            paid: document.getElementById('e-paid').checked,
            planb: document.getElementById('e-planb').value,
            desc: document.getElementById('e-desc').value,
            todos: finalTodos
        };

        if(currentEvId) {
            const idx = appData.events['d'+currentDay].findIndex(e=>e.id===currentEvId);
            appData.events['d'+currentDay][idx] = newEv;
        } else {
            appData.events['d'+currentDay].push(newEv);
        }
        
        persist();
        closeEditor();
        renderAll();
        if(currentEvId && document.getElementById('detail-drawer').classList.contains('active')) {
             openDrawer(currentEvId, currentDay);
        }
    }

    function deleteEvent() {
        if(confirm('åˆªé™¤ï¼Ÿ')) {
            appData.events['d'+currentDay] = appData.events['d'+currentDay].filter(e=>e.id!==currentEvId);
            persist(); closeDrawer(); renderAll();
        }
    }

    function closeEditor() { document.getElementById('editor-modal').classList.remove('active'); }

    // --- Utils ---
    function updateDashboard() {
        let total = 0, pending = 0;
        Object.values(appData.events).forEach(evs => evs.forEach(e => {
            total += (e.cost||0);
            if(!e.paid) pending += (e.cost||0);
        }));
        document.getElementById('dash-total').innerText = `Â¥${total.toLocaleString()}`;
        document.getElementById('dash-pending').innerText = `Â¥${pending.toLocaleString()}`;
    }

    function enterApp() { document.getElementById('portal').classList.add('hidden'); switchTab('desktop'); }
    
    function switchTab(tab) {
        ['desktop','mobile','db'].forEach(t => document.getElementById(t+'-view').style.display = 'none');
        document.getElementById(tab+'-view').style.display = 'block';
        
        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
    }

    function persist() { localStorage.setItem(STORAGE_KEY, JSON.stringify(appData)); }
    
    // Export/Import
    function exportData() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData));
        const node = document.createElement('a');
        node.setAttribute("href", dataStr);
        node.setAttribute("download", "kyushu_plan.json");
        document.body.appendChild(node);
        node.click();
        node.remove();
    }
    
    function importData() { document.getElementById('import-file').click(); }
    function processImport(input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            appData = JSON.parse(e.target.result);
            persist();
            renderAll();
            alert('è¡Œç¨‹åŒ¯å…¥æˆåŠŸï¼');
        };
        reader.readAsText(file);
    }

    init();
  </script>
</body>
</html>
