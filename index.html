<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>2025 ä¹å·æ—…è¡ŒæŒ‡æ®ä¸­å¿ƒ V15</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <!-- Google Fonts & Icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary: #1e3a8a; --primary-light: #3b82f6;
      --accent: #f97316; --bg-body: #f1f5f9; --bg-card: #ffffff;
      --text-main: #0f172a; --text-sub: #64748b; --border: #e2e8f0;
      
      /* Event Colors */
      --evt-move: #e0f2fe; --evt-move-border: #7dd3fc; --evt-move-text: #0369a1;
      --evt-food: #ffedd5; --evt-food-border: #fdba74; --evt-food-text: #c2410c;
      --evt-spot: #dcfce7; --evt-spot-border: #86efac; --evt-spot-text: #15803d;
      --evt-stay: #f3e8ff; --evt-stay-border: #d8b4fe; --evt-stay-text: #7e22ce;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background: var(--bg-body); margin: 0; color: var(--text-main); line-height: 1.5; padding-bottom: 100px; overflow-x: hidden; transition: padding-left 0.3s ease; }

    /* --- Shared --- */
    .btn { padding: 8px 16px; border-radius: 8px; border: 1px solid var(--border); background: white; cursor: pointer; font-size: 13px; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; transition: all 0.2s; }
    .btn:hover { background: #f8fafc; transform: translateY(-1px); }
    .btn-primary { background: var(--primary); color: white; border: none; box-shadow: 0 4px 12px rgba(30,58,138,0.2); }
    .btn-primary:hover { background: #1e40af; }
    
    /* --- Portal --- */
    #portal { position: fixed; inset: 0; background: radial-gradient(circle at top right, #1e3a8a, #0f172a); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; transition: opacity 0.5s; }
    #portal.hidden { opacity: 0; pointer-events: none; }
    .portal-card { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); border-radius: 24px; padding: 32px; width: 160px; cursor: pointer; text-align: center; transition: transform 0.2s; display: inline-flex; flex-direction: column; align-items: center; gap: 12px; margin: 10px; }
    .portal-card:hover { transform: translateY(-5px); background: rgba(255,255,255,0.15); }

    /* --- Side Drawer --- */
    .drawer-backdrop { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.4); backdrop-filter: blur(2px); z-index: 1999; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
    .drawer-backdrop.active { opacity: 1; pointer-events: auto; }
    
    .detail-drawer { position: fixed; top: 0; left: 0; bottom: 0; width: 450px; max-width: 90%; background: white; z-index: 2000; box-shadow: 10px 0 40px rgba(0,0,0,0.1); transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); display: flex; flex-direction: column; border-right: 1px solid var(--border); }
    .detail-drawer.active { transform: translateX(0); }
    
    body.drawer-pinned { padding-left: 450px; }
    body.drawer-pinned .drawer-backdrop { opacity: 0 !important; pointer-events: none !important; }
    body.drawer-pinned .detail-drawer { box-shadow: none; }
    @media (min-width: 1200px) { body.drawer-pinned #desktop-view { max-width: calc(100vw - 480px); margin-left: 20px; } }

    .drawer-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: flex-start; background: #f8fafc; }
    .drawer-title { font-size: 20px; font-weight: 800; color: var(--text-main); line-height: 1.3; margin-bottom: 4px; }
    .drawer-type-badge { font-size: 11px; padding: 4px 8px; border-radius: 6px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; display: inline-block; }
    .drawer-actions { display: flex; gap: 8px; }
    .icon-btn { background: none; border: none; cursor: pointer; color: var(--text-sub); padding: 4px; border-radius: 4px; transition: all 0.2s; }
    .icon-btn:hover { background: rgba(0,0,0,0.05); color: var(--text-main); }
    .icon-btn.active { background: #e0f2fe; color: var(--primary); }

    .drawer-body { flex: 1; overflow-y: auto; padding: 24px; }
    .ctx-card { background: #fff; border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 16px; }
    .ctx-header { display: flex; align-items: center; gap: 8px; font-size: 12px; font-weight: 700; color: var(--text-sub); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
    .ctx-content { font-size: 14px; color: var(--text-main); line-height: 1.6; }
    .ctx-expert { background: #f0f9ff; border-color: #bae6fd; }
    .ctx-expert .ctx-header { color: #0284c7; }
    .ctx-weather { background: #fdf4ff; border-color: #f5d0fe; display: flex; gap: 12px; align-items: center; }
    .ctx-weather .temp { font-size: 24px; font-weight: 800; color: #86198f; }
    .ctx-wear { background: #fafaf9; border-color: #e7e5e4; }
    
    .drawer-footer { padding: 16px 24px; border-top: 1px solid var(--border); background: white; display: flex; justify-content: flex-end; gap: 12px; }
    .drawer-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
    .drawer-info-box { background: #f1f5f9; padding: 12px; border-radius: 12px; }
    .info-label { font-size: 11px; color: var(--text-sub); margin-bottom: 4px; }
    .info-val { font-size: 15px; font-weight: 600; color: var(--text-main); font-family: 'JetBrains Mono', monospace; }

    /* --- Desktop View --- */
    #desktop-view { display: none; max-width: 1800px; margin: 0 auto; padding: 20px; animation: fadeIn 0.5s; }
    #desktop-view.active { display: block; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 16px 24px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); position: sticky; top: 10px; z-index: 100; }
    .title h1 { font-size: 20px; margin: 0; color: var(--primary); }
    .dashboard { display: flex; gap: 20px; margin-bottom: 20px; }
    .dash-card { background: white; padding: 16px; border-radius: 12px; flex: 1; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid var(--border); display: flex; flex-direction: column; justify-content: space-between; }
    .dash-title { font-size: 12px; color: var(--text-sub); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
    .dash-value { font-size: 24px; font-weight: 800; color: var(--text-main); }
    .progress-bar { height: 6px; background: #f1f5f9; border-radius: 3px; margin-top: 8px; overflow: hidden; display: flex; }
    .p-seg { height: 100%; }

    .main-table-wrapper { overflow-x: auto; background: white; border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border: 1px solid var(--border); }
    table { width: 100%; min-width: 1600px; border-collapse: separate; border-spacing: 0; }
    th { position: sticky; top: 0; background: #f8fafc; z-index: 20; padding: 12px; border-bottom: 2px solid var(--border); text-align: left; font-size: 13px; color: var(--text-sub); }
    td { padding: 0; border-right: 1px solid var(--border); vertical-align: top; width: 11.11%; min-width: 180px; position: relative; }
    td:last-child { border-right: none; }
    
    .timeline-container { position: relative; height: 1080px; background: repeating-linear-gradient(to bottom, #fff 0, #fff 59px, #f1f5f9 60px); border-bottom: 1px solid var(--border); cursor: cell; }
    .time-marker { position: absolute; left: 4px; font-size: 10px; color: #cbd5e1; width: 30px; text-align: right; pointer-events: none; }
    
    .event-block { position: absolute; left: 36px; right: 6px; border-radius: 6px; padding: 6px 8px; font-size: 12px; overflow: hidden; cursor: pointer; border-left: 4px solid; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: all 0.2s ease; display: flex; flex-direction: column; }
    .event-block:hover { transform: scale(1.02) translateX(2px); z-index: 50; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
    .ev-time { font-size: 10px; font-weight: 700; opacity: 0.8; margin-bottom: 2px; font-family: 'JetBrains Mono'; }
    .ev-title { font-weight: 600; line-height: 1.3; font-size: 13px; }
    .ev-cost { position: absolute; top: 6px; right: 6px; font-size: 10px; font-weight: 700; background: rgba(255,255,255,0.7); padding: 1px 5px; border-radius: 99px; }
    
    .type-move { background: var(--evt-move); border-color: var(--evt-move-border); color: var(--evt-move-text); }
    .type-food { background: var(--evt-food); border-color: var(--evt-food-border); color: var(--evt-food-text); }
    .type-spot { background: var(--evt-spot); border-color: var(--evt-spot-border); color: var(--evt-spot-text); }
    .type-stay { background: var(--evt-stay); border-color: var(--evt-stay-border); color: var(--evt-stay-text); }

    .row-header { padding: 8px 12px; font-size: 12px; font-weight: 700; background: #f1f5f9; color: var(--text-sub); border-bottom: 1px solid var(--border); border-top: 1px solid var(--border); text-transform: uppercase; letter-spacing: 1px; }
    .cell-content { padding: 12px; font-size: 13px; line-height: 1.6; color: var(--text-main); outline: none; min-height: 80px; }
    .cell-content ul { padding-left: 16px; margin: 0; }
    .cell-content li { margin-bottom: 4px; }
    .cell-content:focus { background: #f0f9ff; }
    .expert-cell { background: #fffbeb; color: #92400e; font-size: 13px; line-height: 1.5; position: relative; }
    .expert-badge { position: absolute; top: 8px; right: 8px; font-size: 16px; }

    /* --- Database View --- */
    #db-view { display: none; max-width: 1400px; margin: 0 auto; padding: 20px; animation: fadeIn 0.5s; }
    #db-view.active { display: block; }
    .db-toolbar { display: flex; gap: 12px; margin-bottom: 20px; background: white; padding: 16px; border-radius: 12px; border: 1px solid var(--border); flex-wrap: wrap; }
    .db-table { width: 100%; border-collapse: collapse; font-size: 13px; background: white; box-shadow: var(--shadow-sm); }
    .db-table th { background: #f8fafc; padding: 10px 12px; text-align: left; border-bottom: 2px solid var(--border); color: var(--text-sub); font-weight: 600; position: sticky; top: 0; }
    .db-table td { padding: 10px 12px; border-bottom: 1px solid var(--border); color: var(--text-main); vertical-align: top; }
    .db-table tr:hover { background: #f8fafc; cursor: pointer; }
    .tag-type { padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; display: inline-block; }

    /* --- Mobile View --- */
    #mobile-view { display: none; max-width: 500px; margin: 0 auto; padding: 16px; }
    #mobile-view.active { display: block; }
    .m-card { background: white; border-radius: 16px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid var(--border); }
    .m-event-row { display: flex; gap: 12px; padding: 12px 0; border-bottom: 1px solid var(--border); cursor: pointer; }
    .m-event-row:last-child { border-bottom: none; }
    .m-time-col { width: 50px; font-size: 12px; font-weight: 600; color: var(--text-sub); text-align: right; flex-shrink: 0; }
    .m-info-col { flex-grow: 1; }
    .m-title { font-weight: 700; color: var(--text-main); font-size: 15px; }
    .m-desc { font-size: 13px; color: var(--text-sub); margin-top: 2px; display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; }

    /* --- Editor Modal --- */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2100; display: none; justify-content: center; align-items: center; }
    .modal-overlay.active { display: flex; }
    .editor-modal { background: white; width: 90%; max-width: 400px; border-radius: 16px; padding: 24px; animation: slideDown 0.2s; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 12px; font-weight: 700; color: var(--text-sub); margin-bottom: 6px; }
    .form-input, .form-select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 15px; outline: none; transition: border-color 0.2s; }
    .editor-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 24px; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  </style>
</head>
<body>

  <!-- Portal -->
  <div id="portal">
    <h1 style="font-size:32px; font-weight:800; margin-bottom:10px;">2025 ä¹å·æŒ‡æ®ä¸­å¿ƒ</h1>
    <div style="font-size:14px; opacity:0.8; margin-bottom:40px;">V15 å¯¦æˆ°è³‡æ–™å¢å¼·ç‰ˆï¼šå®Œæ•´èˆªç­ã€å·´å£«ã€å‚™æ¡ˆã€ç‡Ÿæ¥­æ™‚é–“</div>
    <div>
      <div class="portal-card" onclick="enterApp('mobile')">
        <span class="material-symbols-rounded" style="font-size:40px; margin-bottom:10px;">smartphone</span>
        <div>éš¨è¡Œæ¨¡å¼</div>
      </div>
      <div class="portal-card" onclick="enterApp('desktop')">
        <span class="material-symbols-rounded" style="font-size:40px; margin-bottom:10px;">view_timeline</span>
        <div>æˆ°ç•¥è¦–åœ–</div>
      </div>
      <div class="portal-card" onclick="enterApp('database')">
        <span class="material-symbols-rounded" style="font-size:40px; margin-bottom:10px;">table_view</span>
        <div>è³‡æ–™åº«</div>
      </div>
    </div>
  </div>

  <!-- Detail Drawer (Left Side) -->
  <div class="drawer-backdrop" id="drawer-backdrop" onclick="closeDrawer()"></div>
  <div class="detail-drawer" id="detail-drawer">
    <div class="drawer-header">
        <div style="flex-grow:1">
            <div id="drawer-badge" class="drawer-type-badge"></div>
            <div id="drawer-title" class="drawer-title"></div>
        </div>
        <div class="drawer-actions">
            <button class="icon-btn" id="pin-btn" onclick="togglePin()" title="å›ºå®šé¡¯ç¤º"><span class="material-symbols-rounded">push_pin</span></button>
            <button class="icon-btn" onclick="closeDrawer()" title="é—œé–‰"><span class="material-symbols-rounded">close</span></button>
        </div>
    </div>
    <div class="drawer-body">
        <div class="drawer-info-grid">
            <div class="drawer-info-box">
                <div class="info-label">æ™‚é–“ / æ™‚é•·</div>
                <div class="info-val" id="drawer-time"></div>
            </div>
            <div class="drawer-info-box">
                <div class="info-label">é ç®— (æ¯äºº)</div>
                <div class="info-val" id="drawer-cost"></div>
            </div>
        </div>
        <div class="ctx-card ctx-expert">
            <div class="ctx-header"><span class="material-symbols-rounded">school</span> è€å¸«å‚…ç›¤é»</div>
            <div class="ctx-content" id="drawer-expert"></div>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:16px;">
            <div class="ctx-card ctx-weather" style="margin-bottom:0;">
                <span class="material-symbols-rounded" style="font-size:32px; color:#86198f">thermostat</span>
                <div><div class="info-label">é«”æ„Ÿæº«åº¦</div><div class="temp" id="drawer-temp">--Â°C</div></div>
            </div>
            <div class="ctx-card ctx-wear" style="margin-bottom:0;">
                <div class="ctx-header"><span class="material-symbols-rounded">checkroom</span> ç©¿æ­</div>
                <div class="ctx-content" id="drawer-wear" style="font-size:12px;"></div>
            </div>
        </div>
        <div id="drawer-tips-container" style="display:none; margin-bottom:16px;">
            <div class="ctx-card" style="background:#fff7ed; border-color:#ffedd5; color:#9a3412;">
                <div class="ctx-header" style="color:#c2410c;"><span class="material-symbols-rounded">info</span> ç‡Ÿæ¥­è³‡è¨Š</div>
                <div class="ctx-content" id="drawer-tips"></div>
            </div>
        </div>
        <div class="drawer-section">
            <div class="drawer-section-title"><span class="material-symbols-rounded" style="font-size:16px">description</span> å‚™è¨»</div>
            <div class="drawer-desc" id="drawer-desc"></div>
        </div>
        <div id="drawer-map-link">
            <a href="#" target="_blank" class="btn" style="width:100%; justify-content:center; color:var(--primary);"><span class="material-symbols-rounded">map</span> Google Maps</a>
        </div>
    </div>
    <div class="drawer-footer">
        <button class="btn" style="color:#ef4444;" onclick="deleteEventFromDrawer()">åˆªé™¤</button>
        <button class="btn btn-primary" onclick="editEventFromDrawer()">ç·¨è¼¯å…§å®¹</button>
    </div>
  </div>

  <!-- Desktop View -->
  <div id="desktop-view">
    <div class="header">
      <div class="title"><h1>ğŸ‡¯ğŸ‡µ ä¹å·æˆ°ç•¥åœ–</h1></div>
      <div class="dashboard" style="margin-bottom:0; gap:20px; flex-grow:1; max-width:600px; margin-left:40px;">
         <div class="dash-card" style="padding:10px 16px;">
            <div class="dash-title">ç¸½é ç®— (æ¯äºº)</div>
            <div class="dash-value" id="total-budget">Â¥0</div>
            <div class="progress-bar">
               <div class="p-seg" id="pb-move" style="background:var(--evt-move-text); width:0%"></div>
               <div class="p-seg" id="pb-food" style="background:var(--evt-food-text); width:0%"></div>
               <div class="p-seg" id="pb-stay" style="background:var(--evt-stay-text); width:0%"></div>
               <div class="p-seg" id="pb-spot" style="background:var(--evt-spot-text); width:0%"></div>
            </div>
         </div>
         <div class="dash-card" style="padding:10px 16px;">
            <div class="dash-title">å€’æ•¸è¨ˆæ™‚</div>
            <div class="dash-value" id="countdown">-- å¤©</div>
         </div>
      </div>
      <div style="display:flex; gap:10px;">
        <button class="btn" onclick="enterApp('database')"><span class="material-symbols-rounded">table_view</span> è³‡æ–™åº«</button>
        <button class="btn btn-primary" onclick="window.print()">åˆ—å°</button>
      </div>
    </div>

    <div class="main-table-wrapper">
      <table id="timeline-table">
        <thead><tr id="header-row"></tr></thead>
        <tbody>
          <tr id="timeline-row"></tr>
          <tr><td colspan="10" class="row-header">ğŸ“ é‡é»æ”»ç•¥ (å¿«é€Ÿç­†è¨˜)</td></tr>
          <tr id="core-row"></tr>
          <tr><td colspan="10" class="row-header">ğŸ¨ ä½å®¿å®‰æ’</td></tr>
          <tr id="acc-row"></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Database View -->
  <div id="db-view">
    <div class="header">
      <div class="title"><h1>ğŸ—„ï¸ ä¹å·è¡Œç¨‹è³‡æ–™åº«</h1></div>
      <button class="btn" onclick="enterApp('desktop')">è¿”å›åœ–è¡¨</button>
    </div>
    <div class="db-toolbar">
        <input type="text" class="db-search" placeholder="æœå°‹..." onkeyup="renderDatabase(this.value)">
        <button class="db-filter active" onclick="filterDb('all')">å…¨éƒ¨</button>
        <button class="db-filter" onclick="filterDb('move')">äº¤é€š</button>
        <button class="db-filter" onclick="filterDb('food')">ç¾é£Ÿ</button>
        <button class="db-filter" onclick="filterDb('spot')">æ™¯é»</button>
    </div>
    <div style="background:white; border-radius:12px; border:1px solid var(--border); overflow:hidden;">
        <table class="db-table">
            <thead><tr><th>æ™‚é–“</th><th>é¡å‹</th><th>åç¨±</th><th>è€å¸«å‚…å»ºè­°</th><th>é ç®—(äºº)</th></tr></thead>
            <tbody id="db-tbody"></tbody>
        </table>
    </div>
  </div>

  <!-- Mobile View -->
  <div id="mobile-view">
      <div style="text-align:center; padding:20px;">
          <h2 style="color:var(--primary)">ä¹å·éš¨è¡Œå¡</h2>
          <button class="btn" onclick="switchMode('desktop')">é›»è…¦ç‰ˆ</button>
      </div>
      <div id="m-container"></div>
  </div>

  <!-- Editor Modal -->
  <div class="modal-overlay" id="editor-modal">
    <div class="editor-modal">
      <h3 style="margin-top:0; font-size:18px;">ç·¨è¼¯è¡Œç¨‹</h3>
      <input type="hidden" id="edit-day-id"><input type="hidden" id="edit-event-id">
      <div style="display:flex; gap:10px;">
        <div class="form-group" style="flex:1;"><label class="form-label">é–‹å§‹</label><input type="time" class="form-input" id="edit-start"></div>
        <div class="form-group" style="flex:1;"><label class="form-label">çµæŸ</label><input type="time" class="form-input" id="edit-end"></div>
      </div>
      <div class="form-group"><label class="form-label">åç¨±</label><input type="text" class="form-input" id="edit-title"><div id="shop-info-hint" style="font-size:12px; color:#15803d; margin-top:4px; display:none;"></div></div>
      <div style="display:flex; gap:10px;">
          <div class="form-group" style="flex:1;"><label class="form-label">é¡å‹</label><select class="form-select" id="edit-type"><option value="move">ğŸš— äº¤é€š</option><option value="food">ğŸœ ç¾é£Ÿ</option><option value="spot">ğŸï¸ æ™¯é»</option><option value="stay">ğŸ¨ ä½å®¿</option></select></div>
          <div class="form-group" style="flex:1;"><label class="form-label">é ç®—/äºº</label><input type="number" class="form-input" id="edit-cost"></div>
      </div>
      <div class="form-group"><label class="form-label">å‚™è¨»</label><textarea class="form-input" id="edit-desc" rows="2"></textarea></div>
      
      <!-- New Editor Fields -->
      <div class="form-group"><label class="form-label">è€å¸«å‚…å»ºè­°</label><textarea class="form-input" id="edit-advice" rows="2" style="background:#f0f9ff;"></textarea></div>
      <div style="display:flex; gap:10px;">
          <div class="form-group" style="flex:1;"><label class="form-label">é«”æ„Ÿæº«åº¦</label><input type="text" class="form-input" id="edit-weather"></div>
          <div class="form-group" style="flex:1;"><label class="form-label">ç©¿æ­å»ºè­°</label><input type="text" class="form-input" id="edit-wear"></div>
      </div>

      <div class="editor-actions"><button class="btn" onclick="closeEditor()">å–æ¶ˆ</button><button class="btn btn-primary" onclick="saveEvent()">å„²å­˜</button></div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'kyushu_v15_final_data';
    const daysMeta = [
      {id:1, date:'12/10', w:'ä¸‰', city:'åˆ¥åºœ'}, {id:2, date:'12/11', w:'å››', city:'å¤§åˆ†'}, {id:3, date:'12/12', w:'äº”', city:'ç”±å¸ƒé™¢'},
      {id:4, date:'12/13', w:'å…­', city:'æµ®ç¾½'}, {id:5, date:'12/14', w:'æ—¥', city:'åŸé¶´'}, {id:6, date:'12/15', w:'ä¸€', city:'åšå¤š'},
      {id:7, date:'12/16', w:'äºŒ', city:'åŒ—ä¹å·'}, {id:8, date:'12/17', w:'ä¸‰', city:'åšå¤š'}, {id:9, date:'12/18', w:'å››', city:'è¿”ç¨‹'}
    ];

    // Updated DB with V15 details
    const spotDB = {
      "ç„¼è‚‰ ä¸€åŠ›": { open:"17:00-24:00 (æœ¨æ›œä¼‘)", tips:"ç…™å‘³é‡ï¼Œé¿é–‹æ·ºè‰²è¡£ç‰©ï¼Œå»ºè­°å…ˆè¨‚ä½ã€‚Tabelog 3.86åˆ†" },
      "ã¨ã‚ˆå¸¸": { open:"11:00-21:00 (ç«/æ°´ä¼‘)", tips:"ç‰¹ä¸Šå¤©ä¸¼å¿…é»ï¼Œå»ºè­°11:00å‰æ’éšŠã€‚Tabelog é«˜åˆ†ååº—" },
      "å‹æ°¸ãƒ‘ãƒ³å±‹": { open:"08:30-17:30 (æ—¥æ›œä¼‘)", tips:"åœ¨åœ°ç™¾å¹´éºµåŒ…åº—ï¼Œåªèƒ½ä»˜ç¾ï¼Œè³£å®Œææ—©é—œã€‚Tabelog 3.59åˆ†" },
      "ShinShin": { open:"11:00-03:00", tips:"ç´”æƒ…è±šéª¨æ‹‰éºµï¼Œæ’éšŠäººæ½®å¤š" },
      "é¶´è¦‹å²³çºœè»Š": { open:"09:00-17:00", tips:"å‡ºç™¼å‰å‹™å¿…çœ‹å®˜ç¶² Live Cam ç¢ºèªå±±ä¸Šå¤©æ°£ã€‚éœ§å†°å­£:12æœˆ-3æœˆ" },
      "City Spa": { open:"14:00-24:00 (æ™¨æ¹¯6:00-9:30)", tips:"é ‚æ¨“éœ²å¤©æº«æ³‰å¿…æ³¡ï¼Œæ—¥è½èˆ‡å¤œæ™¯çš†ç¾" },
      "è¥¿é‰„ãƒªã‚¾ãƒ¼ãƒˆã‚¤ãƒ³åˆ¥åºœ": { open:"å¤§æµ´å ´ 15:00-25:00 / 05:00-09:30", tips:"æ—©æ™¨æ³¡æ¹¯å¾Œå¯å»è²·éºµåŒ…" },
      "æ³°æ³‰é–£": { open:"å¢æ—é¢¨å‘‚æœ‰ç”·å¥³äº’æ›åˆ¶", tips:"**æ—©é¤æ–¹æ¡ˆ**ï¼Œæ™šé¤éœ€åœ¨å¤–é¢è§£æ±ºæˆ–è²·é€²å»" },
      "MINOU BOOKS": { open:"11:00-19:00 (ç«æ›œä¼‘)", tips:"æµ®ç¾½å¿…é€›è³ªæ„Ÿæ›¸åº—" },
      "FUK COFFEE": { open:"08:00-20:00", tips:"é£›æ©Ÿä¸»é¡Œå’–å•¡ï¼Œé©åˆæ‹ç…§" },
      "æµ·é®®å±…é…’å±‹ ã‚Œã‚“": { open:"17:00-23:00 (æ—¥æ›œä¼‘)", tips:"Tabelog 3.73åˆ†ï¼Œåˆ¥åºœæ™šé¤é«˜åˆ†å‚™æ¡ˆï¼Œç”Ÿé­šç‰‡æ–°é®®" },
      "Somuri": { open:"11:30-14:00 / 17:30-21:30", tips:"Tabelog 3.68åˆ†ï¼Œè±å¾Œç‰›æ’ï¼Œåˆé¤CPå€¼é«˜ï¼Œæ™šé¤é©åˆæ…¶ç¥" },
      "IT750": { type:"move", desc:"TPE 12:00 -> OIT 15:00" },
      "ç©ºæ¸¯å·´å£«": { type:"move", desc:"AirLiner å¾€åˆ¥åºœåŒ—æµœï¼Œè»Šç¨‹ç´„50åˆ†" }
    };

    const defaultData = {
        events: {
            d1: [
                {id:'e1', start:'10:00', end:'12:00', title:'æ¡ƒæ©Ÿå ±åˆ°', type:'move', cost:0, desc:'T1 è™èˆªæ«ƒæª¯', 
                 advice:'é€™æ™‚é–“äººæ½®å¤šï¼Œå»ºè­°å…ˆç·šä¸Šå ±åˆ°ï¼Œæ‰˜é‹å®Œå» B1 åƒå€‹æ¼¢å ¡ç‹å¢Šèƒƒï¼Œæ©Ÿä¸Šé¤é€šå¸¸åƒä¸é£½ã€‚', weather:'20Â°C (TPE)', wear:'æ´‹è”¥å¼ç©¿æ­ (æ—¥æœ¬å®¤å…§ç†±)'},
                {id:'e2', start:'12:00', end:'15:00', title:'IT750 é£›è¡Œ', type:'move', cost:0, desc:'TPE -> OIT', 
                 advice:'å¤§åˆ†æ©Ÿå ´å¾ˆå°ï¼Œä¸‹é£›æ©Ÿå¾Œå‹•ç·šå–®ç´”ï¼Œä¸ç”¨ç·Šå¼µã€‚', weather:'æ©Ÿè‰™ä¹¾ç‡¥', wear:'èˆ’é©å¯¬é¬†'},
                {id:'e3', start:'16:00', end:'17:00', title:'ç©ºæ¸¯å·´å£« AirLiner', type:'move', cost:1600, desc:'å¾€ã€Œåˆ¥åºœåŒ—æµœ (Beppu Kitahama)ã€', 
                 advice:'â˜…é—œéµï¼šä¸Šè»Šåå·¦é‚Šï¼æ²¿é€”å¯ä»¥çœ‹åˆ°ç¾éº—çš„åˆ¥åºœç£æµ·æ™¯ã€‚è»Šä¸Šæœ‰æš–æ°£ï¼Œå¤–å¥—å¯ä»¥è„«æ‰ã€‚', weather:'8Â°C æµ·é¢¨', wear:'é˜²é¢¨å¤–å¥—'},
                {id:'e4', start:'17:30', end:'19:30', title:'ç„¼è‚‰ ä¸€åŠ›', type:'food', cost:5000, desc:'åœ¨åœ°è€åº—ï¼Œç…™å‘³é‡ä½†è‚‰è³ªæ¥µä½³', 
                 advice:'é€™å®¶æ˜¯ç…™ç‡»åœ°ç„ï¼åƒè¬ä¸è¦ç©¿æ¯›è¡£æˆ–é›£æ´—çš„å¤–å¥—é€²å»ã€‚å‚™æ¡ˆï¼šæµ·é®®å±…é…’å±‹ Ren (Tabelog 3.73)ã€‚', weather:'5Â°C å¯’å†·', wear:'å¯æ©Ÿæ´—çš„ä¸€èˆ¬è¡£ç‰©'},
                {id:'e5', start:'20:00', end:'21:00', title:'è¶…å¸‚æ¡è²·', type:'spot', cost:1000, desc:'Youme Town', 
                 advice:'å› ç‚ºæ˜å¤©é£¯åº—æ²’æ—©é¤ï¼Œä»Šæ™šä¸€å®šè¦å…ˆè²·å¥½éºµåŒ…ã€å„ªæ ¼ã€ç‰›å¥¶ã€‚æ—¥æœ¬ç‰›å¥¶éš¨ä¾¿è²·éƒ½å¥½å–ã€‚', weather:'5Â°C', wear:'ä¿æš–'},
                {id:'e6', start:'21:00', end:'23:59', title:'è¥¿é‰„ãƒªã‚¾ãƒ¼ãƒˆã‚¤ãƒ³', type:'stay', cost:0, desc:'æ³¡æ¹¯', 
                 advice:'å¤§æµ´å ´æœ‰éœ²å¤©æ± ï¼Œåˆ¥åºœçš„æ³‰è³ªå¾ˆå¥½ï¼Œç¬¬ä¸€æ™šå¥½å¥½æ³¡ä¸€ä¸‹æ¶ˆé™¤æ­æ©Ÿç–²å‹ã€‚', weather:'å®¤å…§æº«æš–', wear:'é£¯åº—æµ´è¡£'}
            ],
            d2: [
                {id:'e0', start:'08:00', end:'08:30', title:'æ—©é¤è‡ªç†', type:'food', cost:500, desc:'æˆ¿å…§åƒæ˜¨æ™šè²·çš„ï¼Œæˆ–è¡å‹æ°¸éºµåŒ…å±‹(8:30é–‹)'},
                {id:'e1', start:'09:00', end:'11:30', title:'é¶´è¦‹å²³çºœè»Š', type:'spot', cost:1600, desc:'å±±ä¸Šæ•£æ­¥', 
                 advice:'â˜…å¿…çœ‹å®˜ç¶² Live Cameraï¼å¦‚æœå±±ä¸Šç™½èŒ«èŒ«ä»€éº¼éƒ½çœ‹ä¸åˆ°ï¼Œå°±æœæ–·æ”¾æ£„æ”¹å»åœ°ç„æº«æ³‰æˆ–æµ·æ¿±ç ‚æ¹¯ã€‚', weather:'-2Â°C å¼·é¢¨', wear:'æ¯›å¸½ã€æ‰‹å¥—ã€ç¾½çµ¨è¡£'},
                {id:'e2', start:'11:30', end:'13:00', title:'ã¨ã‚ˆå¸¸', type:'food', cost:1200, desc:'åˆé¤å¤©ä¸¼', 
                 advice:'å‰›ä¸‹å±±èº«é«”å†·ï¼Œåƒç†±é¨°é¨°çš„å¤©ä¸¼æœ€çˆ½ã€‚å»ºè­°11:00é–‹é–€å‰å°±å»æ’ã€‚å¦‚æœæ’å¤ªé•·ï¼Œå»åˆ¥åºœè»Šç«™åˆ†åº—ä¹Ÿå¯ä»¥ã€‚', weather:'9Â°C', wear:'å®¤å…§æš–æ°£å¼·'},
                {id:'e3', start:'15:00', end:'17:00', title:'JR Blossom', type:'stay', cost:0, desc:'Check-in', 
                 advice:'é€™é–“é‡é»æ˜¯é ‚æ¨“ City Spaã€‚å»ºè­°æ—¥è½å‰(16:30)ä¸Šå»æ³¡ä¸€æ¬¡ï¼Œçœ‹è‘—åˆ¥åºœç£å¤•é™½è®Šå¤œæ™¯ã€‚', weather:'å®¤å…§', wear:'è¼•é¬†'},
                {id:'e4', start:'18:00', end:'20:00', title:'Somuri ç‰›æ’', type:'food', cost:6000, desc:'è±å¾Œç‰›', 
                 advice:'è±å¾Œç‰›æ²¹èŠ±è±å¯Œï¼Œå»ºè­°é» Medium-Rareã€‚é€™é¤æ¯”è¼ƒè²´ï¼Œæ…¢æ…¢äº«å—ã€‚', weather:'6Â°C', wear:'ä¼‘é–’æ­£å¼'}
            ],
            d3: [
                {id:'e1', start:'10:00', end:'11:00', title:'ç§»å‹•å¾€ç”±å¸ƒé™¢', type:'move', cost:1100, desc:'JR/Bus', 
                 advice:'å¦‚æœæ˜¯æ­ç”±å¸ƒé™¢ä¹‹æ£®ï¼Œè¨˜å¾—å»é¤è»Šè²·å€‹ B-Speak è›‹ç³•æ²ï¼ˆè»Šä¸Šé™å®šåˆ‡ç‰‡è£ï¼‰ã€‚', weather:'è»Šå…§æš–', wear:'å¥½ç©¿è„«'}, 
                {id:'e2', start:'11:00', end:'14:00', title:'æ¹¯ä¹‹åªè¡—é“', type:'spot', cost:2000, desc:'æ•£ç­–', 
                 advice:'é€™æ¢è·¯äººå¾ˆå¤šï¼Œè·¯é¢å¹³å¦ã€‚å»ºè­°é‚Šèµ°é‚Šåƒå¯æ¨‚é¤…ã€é‡‘è³ç‚¸é›ã€‚ä¸è¦åœ¨é€™é‚Šè²·å¤ªé‡çš„ä¼´æ‰‹ç¦®ï¼Œæè‘—å¾ˆç´¯ã€‚', weather:'5Â°C å±±å€å†·', wear:'å¥½èµ°çš„é‹ã€åœå·¾'},
                {id:'e4', start:'16:00', end:'18:00', title:'ã‚«ãƒ³ãƒˆãƒªãƒ¼ã‚¤ãƒ³éº“èˆ', type:'stay', cost:0, desc:'Check-in', 
                 advice:'é€™å®¶æ™šé¤éå¸¸è±ç››ï¼Œä¸­åˆçœŸçš„ä¸è¦åƒå¤ªé£½ï¼Œä¸ç„¶æ™šä¸Šæœƒå¾Œæ‚”ã€‚', weather:'å®¤å…§', wear:'æµ´è¡£'}
            ],
            d4: [
                {id:'e2', start:'12:30', end:'16:00', title:'æµ®ç¾½ç™½å£æ•£ç­–', type:'spot', cost:500, desc:'ç§Ÿå–®è»Š', 
                 advice:'é¨è…³è¸è»Šé¢¨æœƒçŒé€²è¢–å£ï¼Œè¨˜å¾—æˆ´æ‰‹å¥—ã€‚é€™è£¡éŠå®¢å°‘ï¼Œå¾ˆé©åˆæ‹ç…§ã€‚', weather:'7Â°C æœ‰é¢¨', wear:'æ‰‹å¥—ã€é˜²é¢¨å¤–å¥—'}, 
                {id:'e3', start:'17:00', end:'22:00', title:'Hostel Farolito', type:'stay', cost:0, desc:'å…¥ä½', 
                 advice:'å¤æ°‘å®¶æ”¹å»ºï¼Œæ™šä¸Šå¯èƒ½æœ‰é»é€é¢¨ï¼Œæ€•å†·çš„è©±å¤šè¦æ¢æ¯¯å­ã€‚', weather:'3Â°C å¤œæ™šå†·', wear:'ä¿æš–ç¡è¡£'}
            ],
            d5: [
                {id:'e1', start:'14:00', end:'17:00', title:'æ³°æ³‰é–£', type:'stay', cost:0, desc:'å¢æ—é¢¨å‘‚', 
                 advice:'é€™è£¡çš„æº«æ³‰æ˜¯é›™é‡ç¾è‚Œæ¹¯ï¼Œæ³¡å®Œçš®è†šæœƒå¾ˆæ»‘ã€‚å¢æ—é¢¨å‘‚å¾ˆåƒæ³°å±±é›»å½±å ´æ™¯ï¼Œå¾ˆæœ‰è¶£ã€‚', weather:'æº«æš–', wear:'æµ´è¡£'},
                {id:'e2', start:'17:30', end:'19:00', title:'æ™šé¤è‡ªç†', type:'food', cost:2000, desc:'é‡è¦ï¼', 
                 advice:'å› ç‚ºæ–¹æ¡ˆåªæœ‰æ—©é¤ï¼Œé™„è¿‘æ™šä¸Šå…¨é»‘æ²’åº—é–‹ã€‚ä¸€å®šè¦åœ¨ã€Œæ·æœ¨ã€å·´å£«ç«™æˆ–é“ä¹‹é©›è²·å¥½ä¾¿ç•¶å¸¶é€²å»ã€‚', weather:'-', wear:'-'}
            ],
            d6: [
                {id:'e1', start:'10:00', end:'11:30', title:'ç§»å‹•å¾€åšå¤š', type:'move', cost:1500, desc:'å·´å£«', 
                 advice:'å›åˆ°å¤§åŸå¸‚äº†ï¼å…ˆæŠŠè¡Œæå¯„æ”¾åœ¨é£¯åº—ï¼Œç„¶å¾Œä¸€èº«è¼•å»é€›å¤©ç¥ã€‚', weather:'10Â°C', wear:'éƒ½æœƒé¢¨æ ¼'},
                {id:'e3', start:'20:00', end:'22:00', title:'ä¸­æ´²å±‹å°', type:'spot', cost:2000, desc:'é«”é©—', 
                 advice:'å±‹å°å†¬å¤©åè‘—è…³æœƒå¾ˆå†·ï¼å»ºè­°ç©¿åšè¤²å­ã€‚é»å€‹é—œæ±ç…®ã€æ‹‰éºµå°±å¥½ï¼Œä¸»è¦æ˜¯é«”é©—æ°£æ°›ã€‚', weather:'4Â°C æ²³é‚Šé¢¨å¤§', wear:'åšè¤²å­ã€ç¾½çµ¨è¡£'}
            ],
            d7: [
                {id:'e2', start:'12:00', end:'13:30', title:'é–€å¸æ¸¯ç‡’å’–å“©', type:'food', cost:1200, desc:'åˆé¤', 
                 advice:'é–€å¸æ¸¯æµ·é¢¨è¶…ç´šå¤§ï¼é«”æ„Ÿæº«åº¦æœƒæ¯”åšå¤šä½3-5åº¦ï¼Œå¸½å­ä¸€å®šè¦æˆ´å¥½ã€‚', weather:'5Â°C å¼·æµ·é¢¨', wear:'é˜²é¢¨å¸½ã€å¤§è¡£'}
            ],
            d8: [
                {id:'e3', start:'15:00', end:'19:00', title:'æœ€å¾Œæ¡è²·', type:'spot', cost:10000, desc:'å¤§åœ‹/Uniqlo', 
                 advice:'å¤§åœ‹è—¥å¦é€šå¸¸æ¯”æ¾æœ¬æ¸…ä¾¿å®œã€‚åšå¤šç«™çš„é˜ªæ€¥ç™¾è²¨B1æœ‰è³£ã€ŒåŠªåŠªé›ã€ï¼Œæ˜¯å†·è‘—åƒçš„ç‚¸é›ï¼Œå¾ˆé©åˆç•¶ä¸‹é…’èœã€‚', weather:'å®¤å…§ç†±', wear:'è–„é•·è¢–+åšå¤–å¥—'}
            ],
            d9: [
                {id:'e1', start:'08:30', end:'09:00', title:'å‰å¾€æ©Ÿå ´', type:'move', cost:260, desc:'åœ°éµ', 
                 advice:'ç¦å²¡æ©Ÿå ´å®‰æª¢æœ€è¿‘éå¸¸åš´æ ¼ï¼ŒéšŠä¼æ’å¾ˆé•·ã€‚é›–ç„¶æ©Ÿå ´é›¢å¸‚å€è¿‘ï¼Œä½†é‚„æ˜¯è«‹ææ—©2.5å°æ™‚åˆ°ã€‚', weather:'-', wear:'èˆ’é©'}
            ]
        },
        core: { d1: "æŠµé”åˆ¥åºœã€‚é£¯åº—ç„¡æ—©é¤ï¼Œå»ºè­°ä»Šæ™šå…ˆå»è¶…å•†è²·å¥½ã€‚", d2: "City Spa å¿…æ³¡ã€‚åˆé¤å¤©ä¸¼æ’éšŠã€‚", d3: "ç”±å¸ƒé™¢æ•£ç­–ï¼Œä½éº“èˆã€‚", d4: "æµ®ç¾½é¨è»Šï¼Œæ³¨æ„ä¿æš–ã€‚", d5: "åŸé¶´æ™šé¤è‡ªç†(é‡è¦)ã€‚", d6: "åšå¤šå±‹å°ã€‚", d7: "é–€å¸æ¸¯æµ·é¢¨å¤§ã€‚", d8: "æ¡è²·æ—¥ã€‚", d9: "æ—©é»å»æ©Ÿå ´ã€‚" },
        acc: { d1: "è¥¿é‰„ãƒªã‚¾ãƒ¼ãƒˆã‚¤ãƒ³åˆ¥åºœ (ç´ æ³Š)", d2: "JR Blossom (ç´ æ³Š)", d3: "ã‚«ãƒ³ãƒˆãƒªãƒ¼ã‚¤ãƒ³éº“èˆ (ä¸€æ³ŠäºŒé£Ÿ)", 
            d4: "Hostel Farolito (ç´ æ³Š)", d5: "æ³°æ³‰é–£ (æœé£Ÿä»˜ã)", d6: "Mars Garden (ç´ æ³Š)", 
            d7: "Mars Garden (ç´ æ³Š)", d8: "Mars Garden (ç´ æ³Š)", d9: "æº«æš–çš„å®¶" }
    };

    let appData = {};
    let activeEvId = null;
    let activeDayId = null;
    let isPinned = false;

    function init() {
        const saved = localStorage.getItem(STORAGE_KEY);
        appData = saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(defaultData));
        Object.keys(defaultData.events).forEach(day => {
            if(!appData.events[day]) appData.events[day] = defaultData.events[day];
        });
        renderDesktop();
        renderDatabase();
        updateDashboard();
    }

    function openDrawer(evId, dayId) {
        activeEvId = evId;
        activeDayId = dayId;
        const ev = appData.events['d'+dayId].find(e => e.id === evId);
        if(!ev) return;

        document.getElementById('drawer-title').innerText = ev.title;
        document.getElementById('drawer-badge').innerText = getTypeName(ev.type);
        document.getElementById('drawer-badge').className = `drawer-type-badge type-${ev.type}`;
        document.getElementById('drawer-time').innerText = `${ev.start} - ${ev.end}`;
        document.getElementById('drawer-cost').innerText = `Â¥${ev.cost}`;
        document.getElementById('drawer-desc').innerText = ev.desc || 'ç„¡å‚™è¨»';
        document.getElementById('drawer-expert').innerText = ev.advice || 'æš«ç„¡ç‰¹åˆ¥å»ºè­°';
        document.getElementById('drawer-temp').innerText = ev.weather || '--';
        document.getElementById('drawer-wear').innerText = ev.wear || 'ä¸€èˆ¬ç©¿è‘—';
        document.getElementById('drawer-map-link').querySelector('a').href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(ev.title)}`;

        const dbKey = Object.keys(spotDB).find(k => ev.title.includes(k));
        if(dbKey) {
            const info = spotDB[dbKey];
            document.getElementById('drawer-tips-container').style.display = 'block';
            document.getElementById('drawer-tips').innerHTML = `<strong>${dbKey}</strong><br>${info.open ? `ğŸ•’ ${info.open}<br>` : ''}${info.tips ? `ğŸ’¡ ${info.tips}` : ''}`;
        } else {
            document.getElementById('drawer-tips-container').style.display = 'none';
        }

        if(!isPinned) document.getElementById('drawer-backdrop').classList.add('active');
        document.getElementById('detail-drawer').classList.add('active');
    }

    function closeDrawer() {
        document.getElementById('drawer-backdrop').classList.remove('active');
        document.getElementById('detail-drawer').classList.remove('active');
        if(isPinned) togglePin(); 
    }

    function togglePin() {
        isPinned = !isPinned;
        const btn = document.getElementById('pin-btn');
        if(isPinned) {
            document.body.classList.add('drawer-pinned');
            btn.classList.add('active');
        } else {
            document.body.classList.remove('drawer-pinned');
            btn.classList.remove('active');
            if(document.getElementById('detail-drawer').classList.contains('active')) {
                document.getElementById('drawer-backdrop').classList.add('active');
            }
        }
    }

    function editEventFromDrawer() {
        if(!isPinned) closeDrawer();
        setTimeout(() => openEditor(activeEvId, activeDayId), 100);
    }

    function deleteEventFromDrawer() {
        if(confirm('ç¢ºå®šåˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ')) {
            appData.events['d'+activeDayId] = appData.events['d'+activeDayId].filter(e => e.id !== activeEvId);
            persist();
            closeDrawer();
            renderDesktop();
            renderMobile();
            renderDatabase();
            updateDashboard();
        }
    }

    function openCreateEditor(dayId) {
        activeDayId = dayId; activeEvId = null;
        document.getElementById('edit-start').value = '10:00';
        document.getElementById('edit-end').value = '11:00';
        document.getElementById('edit-title').value = '';
        document.getElementById('edit-cost').value = '';
        document.getElementById('edit-desc').value = '';
        document.getElementById('edit-advice').value = '';
        document.getElementById('edit-weather').value = '';
        document.getElementById('edit-wear').value = '';
        document.getElementById('editor-modal').classList.add('active');
    }

    function openEditor(evId, dayId) {
        activeDayId = dayId; activeEvId = evId;
        const ev = appData.events['d'+dayId].find(e => e.id === evId);
        document.getElementById('edit-start').value = ev.start;
        document.getElementById('edit-end').value = ev.end;
        document.getElementById('edit-title').value = ev.title;
        document.getElementById('edit-type').value = ev.type;
        document.getElementById('edit-cost').value = ev.cost || '';
        document.getElementById('edit-desc').value = ev.desc || '';
        document.getElementById('edit-advice').value = ev.advice || '';
        document.getElementById('edit-weather').value = ev.weather || '';
        document.getElementById('edit-wear').value = ev.wear || '';
        document.getElementById('editor-modal').classList.add('active');
    }

    function saveEvent() {
        const title = document.getElementById('edit-title').value;
        if(!title) return alert("è«‹è¼¸å…¥åç¨±");
        const newEv = {
            id: activeEvId || 'e'+Date.now(),
            start: document.getElementById('edit-start').value,
            end: document.getElementById('edit-end').value,
            title: title,
            type: document.getElementById('edit-type').value,
            cost: parseInt(document.getElementById('edit-cost').value) || 0,
            desc: document.getElementById('edit-desc').value,
            advice: document.getElementById('edit-advice').value,
            weather: document.getElementById('edit-weather').value,
            wear: document.getElementById('edit-wear').value
        };
        
        if(!appData.events['d'+activeDayId]) appData.events['d'+activeDayId] = [];
        
        if(activeEvId) {
            const idx = appData.events['d'+activeDayId].findIndex(e => e.id === activeEvId);
            appData.events['d'+activeDayId][idx] = newEv;
        } else {
            appData.events['d'+activeDayId].push(newEv);
        }
        persist(); closeEditor(); renderDesktop(); renderMobile(); renderDatabase(); updateDashboard();
        
        if(document.getElementById('detail-drawer').classList.contains('active')) {
            openDrawer(newEv.id, activeDayId);
        }
    }

    function closeEditor() { document.getElementById('editor-modal').classList.remove('active'); }
    function persist() { localStorage.setItem(STORAGE_KEY, JSON.stringify(appData)); }
    function saveText(cat, key, txt) { appData[cat][key] = txt; persist(); }
    function getTypeName(t) { return {move:'äº¤é€š', food:'ç¾é£Ÿ', spot:'æ™¯é»', stay:'ä½å®¿'}[t] || t; }

    function renderDesktop() {
        const hRow = document.getElementById('header-row');
        const tRow = document.getElementById('timeline-row');
        const cRow = document.getElementById('core-row');
        const aRow = document.getElementById('acc-row');
        
        hRow.innerHTML = '<th>é …ç›®</th>';
        tRow.innerHTML = '<td style="padding:10px;font-size:12px;color:var(--text-sub);"><strong>24H æ™‚é–“è»¸</strong><br>é»æ“Šå¡ç‰‡é–‹å•Ÿè©³æƒ…</td>';
        cRow.innerHTML = '<td style="padding:10px;">é‡é»</td>';
        aRow.innerHTML = '<td style="padding:10px;">ä½å®¿</td>';

        daysMeta.forEach(d => {
            hRow.innerHTML += `<th><div style="color:var(--primary);font-weight:800;font-size:16px;">${d.date}</div><div style="font-size:12px;">${d.w} | ${d.city}</div><button class="btn" style="width:100%;margin-top:6px;justify-content:center;font-size:11px;" onclick="openCreateEditor(${d.id})">+ è¡Œç¨‹</button></th>`;
            
            let tHtml = `<td class="day-col" style="height:1080px; padding:0; position:relative;"><div class="timeline-container" onclick="openCreateEditor(${d.id})">`;
            for(let h=6; h<24; h+=2) tHtml += `<div class="time-marker" style="top:${(h-6)*60}px">${h}:00</div>`;
            
            const events = appData.events['d'+d.id] || [];
            events.forEach(ev => {
                const [sh, sm] = ev.start.split(':').map(Number);
                const [eh, em] = ev.end.split(':').map(Number);
                const startMin = (sh - 6) * 60 + sm; 
                const duration = ((eh - sh) * 60) + (em - sm);
                const top = startMin;
                const height = Math.max(20, duration); 

                tHtml += `<div class="event-block type-${ev.type}" style="top:${top}px; height:${height}px;" onclick="event.stopPropagation(); openDrawer('${ev.id}', ${d.id})">
                    <span class="ev-time">${ev.start}-${ev.end}</span>
                    <span class="ev-title">${ev.title}</span>
                    ${ev.cost > 0 ? `<span class="ev-cost">Â¥${ev.cost}</span>` : ''}
                </div>`;
            });
            
            tHtml += `</div></td>`;
            tRow.innerHTML += tHtml;
            cRow.innerHTML += `<td><div class="cell-content" contenteditable="true" oninput="saveText('core', 'd${d.id}', this.innerText)">${appData.core['d'+d.id] || ''}</div></td>`;
            aRow.innerHTML += `<td><div class="cell-content" contenteditable="true" oninput="saveText('acc', 'd${d.id}', this.innerText)">${appData.acc['d'+d.id] || ''}</div></td>`;
        });
    }

    function renderMobile() {
        const c = document.getElementById('m-container'); c.innerHTML = '';
        daysMeta.forEach(d => {
            const evs = appData.events['d'+d.id] || [];
            evs.sort((a,b)=>a.start.localeCompare(b.start));
            let html = `<div class="m-card"><h3>Day ${d.id} ${d.city}</h3>`;
            evs.forEach(e => {
                html += `<div class="m-event-row" onclick="openDrawer('${e.id}', ${d.id})">
                    <div class="m-time-col">${e.start}<br>${e.end}</div>
                    <div class="m-info-col">
                        <div class="m-title">${e.title}</div>
                        <div class="m-desc">${e.advice || e.desc || 'ç„¡å‚™è¨»'}</div>
                    </div>
                </div>`;
            });
            html += `</div>`;
            c.innerHTML += html;
        });
    }

    function renderDatabase(search = "") {
        const tbody = document.getElementById('db-tbody');
        tbody.innerHTML = '';
        daysMeta.forEach(d => {
            const events = appData.events['d'+d.id] || [];
            events.forEach(ev => {
                if (currentFilter !== 'all' && ev.type !== currentFilter) return;
                const tr = document.createElement('tr');
                tr.innerHTML = `<td><span style="font-weight:600">${d.date}</span></td><td>${ev.start}-${ev.end}</td><td><span class="tag-type type-${ev.type}">${getTypeName(ev.type)}</span></td><td style="font-weight:600">${ev.title}</td><td>${ev.advice || '-'}</td><td>${ev.cost}</td>`;
                tr.onclick = () => openDrawer(ev.id, d.id);
                tbody.appendChild(tr);
            });
        });
    }

    function updateDashboard() {
        let total = 0; let breakdown = { move:0, food:0, stay:0, spot:0 };
        Object.values(appData.events).forEach(dayEvs => {
            dayEvs.forEach(ev => { const c = parseInt(ev.cost) || 0; total += c; if(breakdown[ev.type] !== undefined) breakdown[ev.type] += c; });
        });
        document.getElementById('total-budget').innerText = `Â¥${total.toLocaleString()}`;
        if(total > 0) {
            document.getElementById('pb-move').style.width = (breakdown.move/total*100)+'%';
            document.getElementById('pb-food').style.width = (breakdown.food/total*100)+'%';
            document.getElementById('pb-stay').style.width = (breakdown.stay/total*100)+'%';
            document.getElementById('pb-spot').style.width = (breakdown.spot/total*100)+'%';
        }
        const diff = Math.ceil((new Date('2025-12-10') - new Date()) / (1000 * 60 * 60 * 24));
        document.getElementById('countdown').innerText = diff > 0 ? `${diff} å¤©` : "å‡ºç™¼ï¼";
    }

    function enterApp(m) { document.getElementById('portal').classList.add('hidden'); switchMode(m); }
    function switchMode(m) {
        const d = document.getElementById('desktop-view');
        const db = document.getElementById('db-view');
        const mb = document.getElementById('mobile-view');
        d.classList.remove('active'); db.classList.remove('active'); mb.classList.remove('active');
        if(m==='desktop') { d.classList.add('active'); renderDesktop(); }
        else if(m==='database') { db.classList.add('active'); renderDatabase(); }
        else { mb.classList.add('active'); renderMobile(); }
    }

    let currentFilter = 'all';
    function filterDb(type) {
        currentFilter = type;
        document.querySelectorAll('.db-filter').forEach(b => b.classList.remove('active'));
        document.querySelector(`.db-filter[onclick="filterDb('${type}')"]`).classList.add('active');
        renderDatabase(); 
    }

    init();
  </script>
</body>
</html>
