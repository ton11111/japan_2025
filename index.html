<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>2025 ä¹å·æ—…è¡ŒæŒ‡æ®ä¸­å¿ƒ V26</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  
  <!-- Fonts & Icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+TC:wght@400;500;700;900&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,600;1,600&display=swap" rel="stylesheet">
  
  <style>
    /* --- 1. System Variables --- */
    :root {
      --primary: #0f172a;       
      --primary-light: #334155; 
      --accent: #0ea5e9;        
      --bg-body: #f8fafc;       
      --bg-surface: #ffffff;
      --text-main: #1e293b;
      --text-sub: #64748b;
      --border: #e2e8f0;
      
      /* Functional Colors */
      --color-transport: #0ea5e9;
      --color-food: #f97316;
      --color-spot: #10b981;
      --color-stay: #8b5cf6;
      
      /* Shadows */
      --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.05);
      --shadow-card: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
      --shadow-float: 0 20px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1);
    }

    /* --- 2. Reset & Global --- */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { 
        font-family: 'Inter', 'Noto Sans TC', sans-serif; 
        background: var(--bg-body); margin: 0; 
        color: var(--text-main); line-height: 1.6; 
        overflow-x: hidden;
        transition: padding-left 0.3s ease;
        min-height: 100vh;
    }

    /* --- 3. Utility Components --- */
    .btn { 
        padding: 8px 16px; border-radius: 8px; border: 1px solid var(--border); 
        background: white; cursor: pointer; font-size: 13px; font-weight: 600; 
        display: inline-flex; align-items: center; gap: 6px; transition: all 0.2s; 
        color: var(--text-main); box-shadow: var(--shadow-sm); text-decoration: none;
    }
    .btn:active { transform: scale(0.98); }
    .btn-primary { background: var(--primary); color: white; border: none; }
    .btn-danger { color: #ef4444; background: #fef2f2; border-color: #fee2e2; }
    .icon-btn { background: none; border: none; cursor: pointer; padding: 8px; border-radius: 50%; color: var(--text-sub); }
    .icon-btn:hover { background: rgba(0,0,0,0.05); color: var(--text-main); }

    /* --- 4. Portal (Entry Screen) --- */
    #portal { 
        position: fixed; inset: 0; background: #0f172a; 
        z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; 
        color: white; transition: opacity 0.4s, visibility 0.4s;
        background-image: url('https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?auto=format&fit=crop&w=1920&q=80');
        background-size: cover; background-position: center;
    }
    #portal::before { content: ''; position: absolute; inset: 0; background: rgba(15, 23, 42, 0.85); z-index: -1; }
    #portal.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
    
    .portal-container { text-align: center; max-width: 800px; padding: 20px; position: relative; z-index: 1; }
    .portal-year { font-family: 'Playfair Display', serif; font-size: 20px; letter-spacing: 4px; color: var(--accent); margin-bottom: 10px; }
    .portal-title { font-size: 48px; font-weight: 900; margin-bottom: 16px; letter-spacing: -1px; line-height: 1.1; }
    .portal-subtitle { font-size: 16px; opacity: 0.8; margin-bottom: 60px; font-weight: 300; letter-spacing: 1px; }

    .portal-cards { display: flex; gap: 24px; justify-content: center; flex-wrap: wrap; }
    .portal-card { 
        background: rgba(255,255,255,0.05); backdrop-filter: blur(20px); 
        border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; 
        padding: 40px 30px; width: 220px; cursor: pointer; text-align: center; 
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); 
    }
    .portal-card:hover { transform: translateY(-10px); background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.3); box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
    .portal-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.9; }
    .portal-card-title { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
    .portal-card-desc { font-size: 12px; opacity: 0.6; }

    /* --- 5. View Containers (Isolation) --- */
    .view-container { display: none; width: 100%; min-height: 100vh; }
    .view-container.active { display: block; animation: fadeIn 0.5s; }
    
    /* --- 6. Mobile View Styles --- */
    #mobile-view { background: #f4f5f7; padding-bottom: 100px; }
    .m-header {
        background: white; color: var(--text-main); padding: 20px 20px 10px;
        position: sticky; top: 0; z-index: 80;
        border-bottom: 1px solid var(--border);
    }
    .m-header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .m-trip-title { font-size: 24px; font-weight: 800; letter-spacing: -0.5px; }
    .m-trip-subtitle { font-size: 11px; color: var(--text-sub); font-weight: 700; letter-spacing: 1px; text-transform: uppercase; }

    /* Day Selector Scroll */
    .m-day-selector-container {
        overflow-x: auto; white-space: nowrap; scrollbar-width: none; 
        padding-bottom: 10px; margin: 0 -20px; padding-left: 20px; padding-right: 20px;
    }
    .m-day-btn {
        display: inline-flex; flex-direction: column; align-items: center; justify-content: center;
        width: 54px; height: 64px; background: #f1f5f9; border-radius: 12px;
        margin-right: 8px; cursor: pointer; transition: all 0.2s;
        color: var(--text-sub); border: 1px solid transparent; flex-shrink: 0;
    }
    .m-day-btn.active {
        background: var(--primary); color: white; transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(15, 23, 42, 0.2);
    }
    .m-day-num { font-size: 18px; font-weight: 700; line-height: 1; }
    .m-day-txt { font-size: 10px; font-weight: 600; margin-top: 2px; }

    .m-content { padding: 20px; max-width: 600px; margin: 0 auto; }
    
    /* Mobile Timeline */
    .m-timeline { position: relative; padding-left: 28px; }
    .m-timeline-line { 
        position: absolute; left: 11px; top: 12px; bottom: 0; 
        width: 2px; background: repeating-linear-gradient(to bottom, #e2e8f0 0, #e2e8f0 6px, transparent 6px, transparent 12px); 
        z-index: 0; 
    }
    .m-event-item { position: relative; margin-bottom: 24px; z-index: 1; }
    .m-event-icon-box {
        position: absolute; left: -28px; top: 0; width: 24px; height: 24px; border-radius: 50%;
        background: white; border: 2px solid var(--border); display: flex; align-items: center; justify-content: center;
        z-index: 2; color: var(--text-sub); font-size: 14px;
    }
    
    .m-event-card {
        background: white; border-radius: 16px; overflow: hidden;
        box-shadow: var(--shadow-sm); transition: transform 0.2s; cursor: pointer;
        border: 1px solid var(--border); display: flex; flex-direction: column;
    }
    .m-event-card:active { transform: scale(0.98); }
    
    .m-card-img-header {
        height: 140px; width: 100%; background-size: cover; background-position: center;
        position: relative;
    }
    .m-card-title-overlay {
        position: absolute; bottom: 0; left: 0; right: 0; padding: 40px 16px 12px;
        background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
        color: white; font-weight: 700; font-size: 16px; text-shadow: 0 1px 3px rgba(0,0,0,0.5);
    }
    
    .m-card-body { padding: 16px; }
    .m-info-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 12px; color: var(--text-sub); font-family: 'JetBrains Mono'; font-weight: 600; }
    
    .highlight-tag {
        display: inline-block; background: #fef9c3; color: #854d0e; 
        padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 700;
        border: 1px solid #fde047; margin-top: 8px;
    }
    .todo-indicator {
        font-size: 10px; color: var(--color-spot); background: #ecfdf5; border: 1px solid #bbf7d0;
        padding: 2px 6px; border-radius: 99px; display: inline-flex; align-items: center; gap: 2px; margin-left: 8px;
    }
    .cash-badge {
        font-size: 10px; background: #dcfce7; color: #15803d; border: 1px solid #86efac;
        padding: 1px 6px; border-radius: 4px; display: inline-flex; align-items: center; gap: 2px; margin-top: 4px;
    }

    /* --- 7. Desktop View Styles --- */
    #desktop-view { max-width: 1800px; margin: 0 auto; padding: 24px; }
    .d-header { 
        display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; 
        background: white; padding: 20px; border-radius: 16px; border: 1px solid var(--border); box-shadow: var(--shadow-sm);
    }
    
    /* Visual Timeline Table */
    .main-table-wrapper { overflow-x: auto; background: white; border-radius: 20px; border: 1px solid var(--border); box-shadow: var(--shadow-card); }
    .desktop-table { width: 100%; min-width: 1600px; border-collapse: separate; border-spacing: 0; }
    .desktop-table th { position: sticky; top: 0; background: #f8fafc; z-index: 20; padding: 16px; border-bottom: 1px solid var(--border); text-align: left; color: var(--text-sub); font-size: 13px; }
    .desktop-table td { padding: 0; border-right: 1px dashed var(--border); vertical-align: top; width: 11.11%; min-width: 200px; position: relative; transition: background 0.2s; }
    .desktop-table td:hover { background: #fcfcfc; }
    
    .timeline-container {
        position: relative; height: 1200px; 
        background-image: linear-gradient(to bottom, var(--border) 1px, transparent 1px);
        background-size: 100% 60px; background-position: 0 20px;
    }
    .time-marker { position: absolute; left: 6px; font-size: 10px; color: #cbd5e1; width: 30px; pointer-events: none; font-family: 'JetBrains Mono'; }
    
    .event-block {
        position: absolute; left: 40px; right: 8px; border-radius: 8px; padding: 0;
        font-size: 12px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: all 0.2s;
        display: flex; flex-direction: column; overflow: hidden; background: white; border: 1px solid var(--border);
    }
    .event-block:hover { transform: scale(1.05); z-index: 50; box-shadow: 0 12px 30px rgba(0,0,0,0.15); }
    .eb-bg { height: 100%; background-size: cover; background-position: center; position: relative; }
    .eb-overlay { position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.8), rgba(0,0,0,0.1)); padding: 8px; display: flex; flex-direction: column; justify-content: flex-end; }
    .eb-title { color: white; font-weight: 700; text-shadow: 0 1px 3px rgba(0,0,0,0.5); line-height: 1.2; }
    .eb-time { color: rgba(255,255,255,0.9); font-size: 10px; font-family: 'JetBrains Mono'; margin-bottom: 2px; }
    .eb-solid { padding: 6px 8px; height: 100%; display: flex; flex-direction: column; justify-content: center; }
    
    .type-move { border-left: 4px solid var(--color-transport); }
    .type-food { border-left: 4px solid var(--color-food); }
    .type-spot { border-left: 4px solid var(--color-spot); }
    .type-stay { border-left: 4px solid var(--color-stay); }

    /* --- 8. Database View --- */
    #db-view { max-width: 1200px; margin: 0 auto; padding: 24px; }
    .db-table-container { background: white; border-radius: 16px; overflow: hidden; border: 1px solid var(--border); box-shadow: var(--shadow-sm); }
    .db-table { width: 100%; border-collapse: collapse; font-size: 13px; background: white; }
    .db-table th, .db-table td { padding: 12px 16px; border-bottom: 1px solid var(--border); text-align: left; }
    .db-table tr:hover { background: #f8fafc; cursor: pointer; }

    /* --- 9. Bottom Nav (Mobile Only) --- */
    .bottom-nav {
        position: fixed; bottom: 0; left: 0; width: 100%;
        background: rgba(255,255,255,0.95); backdrop-filter: blur(20px);
        border-top: 1px solid rgba(0,0,0,0.05);
        display: none; justify-content: space-around; padding: 10px 0;
        z-index: 1000; padding-bottom: calc(10px + env(safe-area-inset-bottom));
        box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
    }
    .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; background: none; border: none; color: #94a3b8; font-size: 10px; font-weight: 600; cursor: pointer; width: 20%; }
    .nav-item.active { color: var(--primary); }
    .nav-item span { font-size: 24px; }
    @media (max-width: 768px) { .bottom-nav { display: flex; } }

    /* --- 10. Drawer & Modals --- */
    .drawer-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(2px); z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
    .drawer-backdrop.active { opacity: 1; pointer-events: auto; }
    
    .detail-drawer { 
        position: fixed; top: 0; left: 0; bottom: 0; width: 480px; max-width: 90%; 
        background: white; z-index: 2001; transform: translateX(-100%); 
        transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); 
        display: flex; flex-direction: column; box-shadow: 10px 0 50px rgba(0,0,0,0.15); 
        border-right: 1px solid var(--border);
    }
    .detail-drawer.active { transform: translateX(0); }
    
    body.drawer-pinned { padding-left: 480px; }
    body.drawer-pinned .drawer-backdrop { display: none; }
    @media (max-width: 1024px) { body.drawer-pinned { padding-left: 0; } }

    .drawer-header { padding: 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: flex-start; background: white; }
    .drawer-body { flex: 1; overflow-y: auto; padding: 24px; background: #fcfcfc; }
    .drawer-footer { padding: 16px 24px; border-top: 1px solid var(--border); background: white; display: flex; justify-content: space-between; align-items: center; }
    
    /* Editor Modal */
    #editor-overlay, #modal-container { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 11000; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
    .editor-modal { background: white; width: 90%; max-width: 450px; border-radius: 24px; padding: 24px; max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow-float); animation: fadeIn 0.2s; }
    .form-input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; margin-bottom: 12px; font-family: inherit; }

    .checkbox-wrapper { display: flex; align-items: center; gap: 8px; margin-top: 6px; cursor: pointer; user-select: none; }
    .checkbox-input { width: 18px; height: 18px; accent-color: var(--accent); cursor: pointer; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body>

  <!-- 0. Portal -->
  <div id="portal">
    <div class="portal-container">
        <div class="portal-year">EST. 2025</div>
        <div class="portal-title">KYUSHU<br>ODYSSEY</div>
        <div class="portal-subtitle">ä¹å·æ—…è¡ŒæŒ‡æ®ä¸­å¿ƒ V26 (æœ€çµ‚ä¿®å¾©ç‰ˆ)</div>
        
        <div class="portal-cards">
            <div class="portal-card" onclick="enterApp('mobile')">
                <div class="portal-icon">ğŸ“±</div>
                <div class="portal-card-title">éš¨è¡Œæ¨¡å¼</div>
                <div class="portal-card-desc">æ‰‹æ©Ÿç€è¦½æœ€ä½³åŒ–</div>
            </div>
            <div class="portal-card" onclick="enterApp('desktop')">
                <div class="portal-icon">ğŸ—ºï¸</div>
                <div class="portal-card-title">æˆ°ç•¥è¦–åœ–</div>
                <div class="portal-card-desc">å®Œæ•´æ™‚é–“è»¸è¦åŠƒ</div>
            </div>
            <div class="portal-card" onclick="enterApp('db')">
                <div class="portal-icon">ğŸ—„ï¸</div>
                <div class="portal-card-title">è³‡æ–™åº«</div>
                <div class="portal-card-desc">æ¸…å–®èˆ‡æœå°‹</div>
            </div>
        </div>
    </div>
  </div>

  <!-- 1. Mobile View -->
  <div id="mobile-view" class="view-container">
    <div class="m-header">
        <div class="m-header-top">
            <div>
                <div class="m-trip-subtitle">DECEMBER 10-18</div>
                <div class="m-trip-title">ä¹å·ç¸±æ–·ä¹‹æ—…</div>
            </div>
            <button class="icon-btn" onclick="showPortal()"><span class="material-symbols-rounded">home</span></button>
        </div>
        <div class="m-day-selector-container" id="m-day-selector"></div>
    </div>
    
    <div class="m-content">
        <div class="m-tip-card">
            <div class="m-tip-icon"><span class="material-symbols-rounded">lightbulb</span></div>
            <div>
                <div style="font-size:12px; font-weight:700; color:var(--accent); margin-bottom:4px;">ä»Šæ—¥é‡é»</div>
                <div id="m-daily-advice" style="font-size:14px; color:var(--text-main); line-height:1.5;"></div>
            </div>
        </div>
        <div class="m-timeline" id="m-timeline-list"></div>
    </div>
  </div>

  <!-- 2. Desktop View -->
  <div id="desktop-view" class="view-container">
      <div class="d-header">
          <div>
              <div style="font-size:12px; color:var(--text-sub); font-weight:700;">COMMAND CENTER</div>
              <h1 style="color:var(--primary);">è¡Œç¨‹æˆ°ç•¥è¦–åœ–</h1>
          </div>
          <div style="display:flex; gap:24px; align-items:center;">
               <div style="text-align:right;">
                   <div style="font-size:11px; color:var(--text-sub);">é ä¼°ç¸½é ç®—</div>
                   <div id="dash-total" style="font-size:18px; font-weight:800;">Â¥0</div>
               </div>
               <div style="text-align:right;">
                   <div style="font-size:11px; color:var(--color-food);">å¿…å‚™ç¾é‡‘ (Cash Only)</div>
                   <div id="dash-cash" style="font-size:18px; font-weight:800; color:var(--color-food);">Â¥0</div>
               </div>

               <div style="display:flex; gap:8px;">
                   <button class="btn" onclick="openGlobalChecklist()"><span class="material-symbols-rounded">checklist</span> è¡Œå‰</button>
                   <button class="btn btn-sos" onclick="openEmergency()"><span class="material-symbols-rounded">sos</span> ç·Šæ€¥</button>
                   <button class="btn" onclick="exportData()">å‚™ä»½</button>
                   <button class="btn" onclick="importData()">é‚„åŸ</button>
                   <button class="btn" onclick="showPortal()">é¦–é </button>
               </div>
          </div>
          <input type="file" id="import-file" style="display:none" onchange="processImport(this)">
      </div>
      <div style="overflow:auto; border:1px solid var(--border); border-radius:16px; height:80vh;">
          <table class="desktop-table">
              <thead><tr id="d-header-row" style="position:sticky; top:0; background:#f8fafc; z-index:10;"></tr></thead>
              <tbody id="d-body-row"></tbody>
          </table>
      </div>
  </div>

  <!-- 3. Database View -->
  <div id="db-view" class="view-container">
      <div class="d-header" style="background:white; padding:20px; border-radius:16px; border:1px solid var(--border); display:flex; justify-content:space-between; margin-bottom:20px;">
          <h1>ğŸ—„ï¸ è¡Œç¨‹è³‡æ–™åº«</h1>
          <button class="btn" onclick="showPortal()">è¿”å›é¦–é </button>
      </div>
      <div class="db-table-container" style="background:white; border-radius:12px; overflow:hidden; border:1px solid var(--border);">
          <table class="db-table">
              <thead><tr><th>æ—¥æœŸ</th><th>æ™‚é–“</th><th>é¡å‹</th><th>åç¨±</th><th>é‡é»å‚™è¨»</th><th>é ç®—</th></tr></thead>
              <tbody id="db-tbody"></tbody>
          </table>
      </div>
  </div>

  <!-- Detail Drawer -->
  <div class="drawer-backdrop" id="drawer-backdrop" onclick="closeDrawer()"></div>
  <div class="detail-drawer" id="detail-drawer">
      <div class="drawer-header">
          <div style="flex-grow:1">
             <div class="text-sm font-weight-bold text-sub" id="d-drawer-type">TYPE</div>
             <div style="font-size:24px; font-weight:800; line-height:1.2;" id="d-drawer-title">Title</div>
          </div>
          <div style="display:flex; gap:4px;">
              <button class="icon-btn" onclick="togglePin()" title="å›ºå®š"><span class="material-symbols-rounded">push_pin</span></button>
              <button class="icon-btn" onclick="closeDrawer()" title="é—œé–‰"><span class="material-symbols-rounded">close</span></button>
          </div>
      </div>
      <div class="drawer-body">
          <div id="d-drawer-img-container" style="margin-bottom:24px; display:none;">
              <img id="d-drawer-img" src="" style="width:100%; height:200px; object-fit:cover; border-radius:16px; box-shadow: var(--shadow-sm);">
          </div>
          <div style="background:#f0f9ff; padding:12px; border-radius:8px; border:1px solid #bae6fd; margin-bottom:16px; color:#0369a1; font-weight:600;" id="d-drawer-note"></div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:20px;">
              <div style="background:#f1f5f9; padding:12px; border-radius:12px;">
                  <div class="text-xs text-sub">æ™‚é–“</div>
                  <div class="font-mono font-weight-bold" id="d-drawer-time">--:--</div>
              </div>
              <div style="background:#f1f5f9; padding:12px; border-radius:12px;">
                  <div class="text-xs text-sub">é ç®— (ç¾é‡‘?)</div>
                  <div class="font-mono font-weight-bold" id="d-drawer-cost">Â¥0</div>
              </div>
          </div>
          
          <div id="d-drawer-onsen-container" style="display:none; margin-bottom:16px;">
              <div style="background:#f3e8ff; border:1px solid #d8b4fe; color:#6b21a8; padding:12px; border-radius:12px;">
                  <div style="font-weight:700; font-size:13px; margin-bottom:4px; display:flex; align-items:center; gap:4px;"><span class="material-symbols-rounded" style="font-size:16px;">hot_tub</span> æº«æ³‰æƒ…å ±</div>
                  <div id="d-drawer-onsen" style="font-size:13px;"></div>
              </div>
          </div>

          <div id="d-drawer-planb" style="display:none; background:#f1f5f9; padding:12px; border-radius:12px; margin-bottom:20px; border:1px dashed var(--text-sub);">
              <div style="font-weight:700; font-size:13px; display:flex; align-items:center; gap:6px;">
                  <span class="material-symbols-rounded">rainy</span> å‚™æ¡ˆè¡Œç¨‹
              </div>
              <div id="d-drawer-planb-text" style="font-size:13px; margin-top:4px; color:var(--text-sub);"></div>
          </div>

          <div style="margin-bottom:20px;">
              <div class="text-xs font-weight-bold text-sub" style="margin-bottom:6px;">è©³ç´°æ”»ç•¥ & å‚™è¨»</div>
              <div id="d-drawer-desc" style="font-size:14px; line-height:1.6;"></div>
          </div>
          
          <div style="margin-bottom:24px;">
              <div class="text-xs font-weight-bold text-sub" style="margin-bottom:8px;">å¾…è¾¦äº‹é …</div>
              <div id="d-todo-list" style="border:1px solid var(--border); border-radius:8px; overflow:hidden;"></div>
              <button class="btn" style="width:100%; font-size:12px; margin-top:8px; border-style:dashed;" onclick="openEditor(null, true)">+ ç·¨è¼¯å¾…è¾¦</button>
          </div>

          <div style="background:#f0f9ff; padding:16px; border-radius:12px; border:1px solid #bae6fd; margin-bottom:20px;">
              <div style="font-size:11px; font-weight:700; color:#0284c7; margin-bottom:6px;">ğŸ‘¨â€ğŸ« è€å¸«å‚…å»ºè­°</div>
              <div id="d-drawer-advice" style="font-size:13px; color:#0c4a6e;"></div>
          </div>
      </div>
      <div class="drawer-footer">
          <button class="btn btn-danger" onclick="deleteEvent()">åˆªé™¤</button>
          <button class="btn btn-primary" onclick="openEditor()">ç·¨è¼¯å…§å®¹</button>
      </div>
  </div>

  <!-- Bottom Nav -->
  <div class="bottom-nav">
      <button class="nav-item active" onclick="switchTab('mobile')"><span class="material-symbols-rounded">explore</span>è¡Œç¨‹</button>
      <button class="nav-item" onclick="switchTab('desktop')"><span class="material-symbols-rounded">map</span>æˆ°ç•¥åœ–</button>
      <button class="nav-item" onclick="switchTab('db')"><span class="material-symbols-rounded">table_rows</span>è³‡æ–™åº«</button>
      <button class="nav-item" onclick="openGlobalChecklist()"><span class="material-symbols-rounded">checklist</span>æº–å‚™</button>
      <button class="nav-item" onclick="openEmergency()"><span class="material-symbols-rounded">sos</span>ç·Šæ€¥</button>
  </div>

  <!-- Editor Modal -->
  <div id="editor-overlay">
      <div class="editor-modal">
          <h3 style="margin-top:0;">ç·¨è¼¯è¡Œç¨‹</h3>
          <input type="hidden" id="e-day-id"><input type="hidden" id="e-id">
          
          <label class="text-xs font-weight-bold text-sub">æ¨™é¡Œ</label>
          <input id="e-title" class="form-input" placeholder="åç¨±">
          
          <div style="display:flex; gap:10px;">
              <div style="flex:1"><label class="text-xs font-weight-bold text-sub">é–‹å§‹</label><input type="time" id="e-start" class="form-input"></div>
              <div style="flex:1"><label class="text-xs font-weight-bold text-sub">çµæŸ</label><input type="time" id="e-end" class="form-input"></div>
          </div>
          
          <div style="display:flex; gap:10px;">
              <div style="flex:1">
                  <label class="text-xs font-weight-bold text-sub">é¡å‹</label>
                  <select id="e-type" class="form-input">
                      <option value="move">äº¤é€š</option><option value="food">ç¾é£Ÿ</option><option value="spot">æ™¯é»</option><option value="stay">ä½å®¿</option>
                  </select>
              </div>
              <div style="flex:1"><label class="text-xs font-weight-bold text-sub">é ç®—</label><input type="number" id="e-cost" class="form-input" placeholder="0"></div>
          </div>
          
          <div style="margin-bottom:12px; display:flex; gap:16px;">
              <label class="checkbox-wrapper">
                  <input type="checkbox" class="checkbox-input" id="e-paid"> <span style="font-size:12px;">å·²ä»˜æ¬¾</span>
              </label>
              <label class="checkbox-wrapper">
                  <input type="checkbox" class="checkbox-input" id="e-cash"> <span style="font-size:12px; color:var(--color-food);">åƒ…æ”¶ç¾é‡‘</span>
              </label>
          </div>

          <label class="text-xs font-weight-bold text-sub">å¾…è¾¦äº‹é … (ä¸€è¡Œä¸€å€‹)</label>
          <textarea id="e-todos" class="form-input" rows="2" placeholder="é ç´„é¤å»³&#10;è³¼è²·é–€ç¥¨"></textarea>

          <label class="text-xs font-weight-bold text-sub">é‡é»å‚™è¨»</label>
          <input id="e-note" class="form-input" placeholder="ä¾‹å¦‚: åå·¦å´ã€åªæ”¶ç¾é‡‘">

          <label class="text-xs font-weight-bold text-sub">è©³ç´°æ”»ç•¥</label>
          <textarea id="e-desc" class="form-input" rows="3"></textarea>

          <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
              <button class="btn" onclick="closeEditor()">å–æ¶ˆ</button>
              <button class="btn btn-primary" onclick="saveEvent()">å„²å­˜</button>
          </div>
      </div>
  </div>

  <!-- Modal Container -->
  <div id="modal-container">
      <div class="editor-modal" style="width:90%; max-width:500px;">
          <div id="modal-content"></div>
          <div style="margin-top:20px; text-align:right;">
              <button class="btn" onclick="document.getElementById('modal-container').style.display='none'">é—œé–‰</button>
          </div>
      </div>
  </div>

  <script>
    const STORAGE_KEY = 'kyushu_v26_fixed';
    
    // Images
    const IMGS = {
        beppu: "https://images.unsplash.com/photo-1576485290814-1c72aa4bbb8e?auto=format&fit=crop&w=600&q=80",
        yakiniku: "https://images.unsplash.com/photo-1594041680534-e8c8cdebd659?auto=format&fit=crop&w=600&q=80",
        ropeway: "https://images.unsplash.com/photo-1480497490787-505ec076689f?auto=format&fit=crop&w=600&q=80",
        tempura: "https://images.unsplash.com/photo-1615361200141-f45040f367be?auto=format&fit=crop&w=600&q=80",
        yufuin: "https://images.unsplash.com/photo-1516205651411-a85243675391?auto=format&fit=crop&w=600&q=80",
        hotel: "https://images.unsplash.com/photo-1582719508461-905c673771fd?auto=format&fit=crop&w=600&q=80",
        train: "https://images.unsplash.com/photo-1474487548417-781a5a8cae56?auto=format&fit=crop&w=600&q=80"
    };

    const daysMeta = [
      {id:1, date:'12/10 (ä¸‰)', city:'åˆ¥åºœ'}, {id:2, date:'12/11 (å››)', city:'å¤§åˆ†'}, 
      {id:3, date:'12/12 (äº”)', city:'ç”±å¸ƒé™¢'}, {id:4, date:'12/13 (å…­)', city:'æµ®ç¾½'}, 
      {id:5, date:'12/14 (æ—¥)', city:'åŸé¶´'}, {id:6, date:'12/15 (ä¸€)', city:'åšå¤š'},
      {id:7, date:'12/16 (äºŒ)', city:'åŒ—ä¹å·'}, {id:8, date:'12/17 (ä¸‰)', city:'åšå¤š'}, 
      {id:9, date:'12/18 (å››)', city:'è¿”ç¨‹'}
    ];

    const defaultData = {
        checklist: [
            {text:"è­·ç…§ (æœ‰æ•ˆæœŸé™6å€‹æœˆä»¥ä¸Š)", done:false},
            {text:"Visit Japan Web å¡«å¯«æˆªåœ–", done:false},
            {text:"æ—¥å¹£ç¾é‡‘ (è‡³å°‘ Â¥50,000)", done:false},
            {text:"ç¶²å¡ / Roaming é–‹é€š", done:false},
            {text:"è¡Œå‹•é›»æº + å……é›»ç·š", done:false},
            {text:"ç‰™åˆ·ç‰™è† (éƒ¨åˆ†é£¯åº—ä¸æä¾›)", done:false}
        ],
        events: {
            d1: [
                {id:'e1', start:'10:00', end:'12:00', title:'âœˆï¸ æ¡ƒæ©Ÿå ±åˆ°', type:'move', cost:0, paid:true, desc:'T1 è™èˆªæ«ƒæª¯', todos:[{text:'ç·šä¸Šå ±åˆ°',done:false}]},
                {id:'e2', start:'12:00', end:'15:00', title:'IT750 é£›è¡Œ', type:'move', cost:0, paid:true, desc:'PNR: B8453T | Tigerlight', advice:'è¨‚å–®ç·¨è™Ÿ B8453Tã€‚å¤§åˆ†æ©Ÿå ´å¾ˆå°ï¼Œä¸‹é£›æ©Ÿå¾Œå‹•ç·šå–®ç´”ã€‚'},
                {id:'e3', start:'16:00', end:'17:00', title:'ğŸšŒ ç©ºæ¸¯å·´å£«', type:'move', cost:1600, paid:false, cashOnly:true, desc:'å¾€åˆ¥åºœåŒ—æµœ', advice:'åå·¦é‚Šçœ‹æµ·ï¼', img:IMGS.train},
                {id:'e4', start:'17:30', end:'19:30', title:'ğŸ¥© ç‡’è‚‰ä¸€åŠ›', type:'food', cost:5000, paid:false, cashOnly:true, desc:'åœ¨åœ°è€åº—ï¼Œç…™å‘³é‡', img:IMGS.yakiniku, advice:'ç…™ç‡»åœ°ç„ï¼å‹¿ç©¿æ¯›è¡£ã€‚'},
                {id:'e5', start:'21:00', end:'23:59', title:'ğŸ¨ è¥¿é‰„åˆ¥åºœ', type:'stay', cost:0, paid:true, desc:'æ³¡æ¹¯ä¼‘æ¯', img:IMGS.hotel, onsen:'å¤§æµ´å ´ 15:00-01:00 / 05:00-09:30ã€‚'}
            ],
            d2: [
                {id:'e1', start:'09:00', end:'11:30', title:'ğŸš  é¶´è¦‹å²³çºœè»Š', type:'spot', cost:1600, paid:false, cashOnly:false, desc:'å±±ä¸Šé›¶åº¦', img:IMGS.ropeway, advice:'â˜…å¿…çœ‹å®˜ç¶² Live Cameraï¼'},
                {id:'e2', start:'11:30', end:'13:00', title:'ğŸ¤ ã¨ã‚ˆå¸¸ å¤©ä¸¼', type:'food', cost:1200, paid:false, cashOnly:true, desc:'11:00æ’éšŠ', img:IMGS.tempura},
                {id:'e3', start:'15:00', end:'17:00', title:'ğŸ¨ JR Blossom', type:'stay', cost:0, paid:true, desc:'City Spa', img:IMGS.beppu, onsen:'City Spa 14:00-24:00 / 06:00-09:30ã€‚é ‚æ¨“éœ²å¤©ã€‚'}
            ],
            d3: [
                {id:'e1', start:'10:00', end:'11:00', title:'ğŸš‚ ç§»å‹•å¾€ç”±å¸ƒé™¢', type:'move', cost:1100, desc:'JR ä¹…å¤§æœ¬ç·š', img:IMGS.train},
                {id:'e2', start:'11:00', end:'14:00', title:'ğŸ“· æ¹¯ä¹‹åªè¡—é“', type:'spot', cost:2000, desc:'é‚Šåƒé‚Šé€›', img:IMGS.yufuin},
                {id:'e3', start:'16:00', end:'18:00', title:'ğŸ¨ ã‚«ãƒ³ãƒˆãƒªãƒ¼ã‚¤ãƒ³éº“èˆ', type:'stay', cost:0, desc:'Check-inï¼Œæ™šé¤è±ç››', img:IMGS.hotel}
            ],
            d4: [{id:'e2', start:'12:30', end:'16:00', title:'æµ®ç¾½ç™½å£æ•£ç­–', type:'spot', cost:500, desc:'ç§Ÿå–®è»Š'},{id:'e3', start:'17:00', end:'22:00', title:'Hostel Farolito', type:'stay', cost:0, desc:'å…¥ä½'}],
            d5: [{id:'e1', start:'14:00', end:'17:00', title:'æ³°æ³‰é–£ Check-in', type:'stay', cost:0, desc:'å¢æ—é¢¨å‘‚', onsen:'å¢æ—é¢¨å‘‚(ç”·å¥³äº’æ›)ã€é›™é‡ç¾è‚Œæ¹¯ã€‚'},{id:'e2', start:'17:30', end:'19:00', title:'æ™šé¤è‡ªç† (é‡è¦)', type:'food', cost:2000, desc:'å»ºè­°åœ¨æ·æœ¨æˆ–é“ä¹‹é©›è²·å¥½ä¾¿ç•¶'}],
            d6: [{id:'e1', start:'10:00', end:'11:30', title:'ç§»å‹•å¾€åšå¤š', type:'move', cost:1500, desc:'å·´å£«'},{id:'e3', start:'20:00', end:'22:00', title:'ä¸­æ´²å±‹å°', type:'spot', cost:2000, desc:'é«”é©—'}],
            d9: [{id:'e1', start:'08:30', end:'09:00', title:'å‰å¾€æ©Ÿå ´', type:'move', cost:260, desc:'åœ°éµ'},{id:'e3', start:'10:55', end:'12:40', title:'IT241 è¿”ç¨‹', type:'move', cost:0, desc:'PNR: B8453T'}]
        },
        expert: { d1: "å·´å£«äººå¤šè¦æ’éšŠï¼Œå‹•ä½œå¿«ã€‚", d2: "City Spa é¢¨å¤§ï¼Œé ­åŒ…æ¯›å·¾ã€‚" }
    };

    let appData = {};
    let currentMobileDay = 1;
    let currentEvId = null;
    let currentDayId = null;
    let isPinned = false;

    function init() {
        const saved = localStorage.getItem(STORAGE_KEY);
        appData = saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(defaultData));
        daysMeta.forEach(d => { if(!appData.events['d'+d.id]) appData.events['d'+d.id] = []; });
        enterApp('mobile'); // Default
    }

    // --- Navigation & Entry ---
    function enterApp(mode) {
        document.getElementById('portal').classList.add('hidden');
        switchTab(mode);
    }
    
    function switchTab(tab) {
        ['desktop','mobile','db'].forEach(t => document.getElementById(t+'-view').classList.remove('active'));
        document.getElementById(tab+'-view').classList.add('active');
        
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        if(tab==='mobile') { document.querySelectorAll('.nav-item')[0].classList.add('active'); renderMobile(); }
        if(tab==='desktop') { document.querySelectorAll('.nav-item')[1].classList.add('active'); renderDesktopTable(); }
        if(tab==='db') { document.querySelectorAll('.nav-item')[2].classList.add('active'); renderDB(); }
        updateDashboard();
    }

    function showPortal() {
        document.getElementById('portal').classList.remove('hidden');
    }

    // --- Global Checklist ---
    function openGlobalChecklist() {
        const modal = document.getElementById('modal-container');
        const content = document.getElementById('modal-content');
        modal.style.display = 'flex';
        
        let html = `<h3>ğŸ§³ è¡Œå‰æº–å‚™ç¸½æ¸…å–®</h3><div class="drawer-todo-list" style="border:1px solid #eee; border-radius:12px;">`;
        appData.checklist.forEach((item, i) => {
            html += `<div class="todo-item ${item.done?'done':''}" onclick="toggleGlobalCheck(${i})">
                <input type="checkbox" class="todo-checkbox" ${item.done?'checked':''}>
                <div class="drawer-todo-text ${item.done?'done':''}">${item.text}</div>
            </div>`;
        });
        html += `</div><button class="btn" style="width:100%; border-style:dashed;" onclick="addGlobalCheck()">+ æ–°å¢é …ç›®</button>`;
        content.innerHTML = html;
    }
    function toggleGlobalCheck(i) { appData.checklist[i].done = !appData.checklist[i].done; persist(); openGlobalChecklist(); }
    function addGlobalCheck() { const t = prompt("è¼¸å…¥å¾…è¾¦äº‹é …ï¼š"); if(t){ appData.checklist.push({text:t, done:false}); persist(); openGlobalChecklist(); } }

    function openEmergency() {
        const modal = document.getElementById('modal-container');
        const content = document.getElementById('modal-content');
        modal.style.display = 'flex';
        content.innerHTML = `<h3 style="color:#dc2626;">ğŸ†˜ ç·Šæ€¥è³‡è¨Š</h3><div style="background:#fef2f2;padding:15px;border-radius:10px;">å ±è­¦ 110 | æ•‘è­· 119<br>é§æ—¥ä»£è¡¨è™•: 092-734-2810</div>`;
    }

    // --- Renderers ---
    function renderMobile() {
        const selector = document.getElementById('m-day-selector');
        selector.innerHTML = '';
        daysMeta.forEach(d => {
            const isActive = d.id === currentMobileDay ? 'active' : '';
            selector.innerHTML += `<div class="m-day-btn ${isActive}" onclick="setMobileDay(${d.id})"><div class="m-day-num">${d.date.split('/')[1].split(' ')[0]}</div><div class="m-day-txt">${d.w}</div></div>`;
        });
        document.getElementById('m-daily-advice').innerHTML = appData.expert['d'+currentMobileDay] || "äº«å—æ—…ç¨‹ï¼";
        
        const list = document.getElementById('m-timeline-list');
        list.innerHTML = '<div class="m-timeline-line"></div>';
        const events = appData.events['d'+currentMobileDay] || [];
        events.sort((a,b)=>a.start.localeCompare(b.start));

        if(events.length===0) { list.innerHTML += '<div style="padding:20px;text-align:center;color:#999">æœ¬æ—¥ç„¡è¡Œç¨‹</div>'; }

        events.forEach(ev => {
            let imgStyle = ev.img ? `background-image:url('${ev.img}'); height:140px;` : 'display:none;';
            let noteHtml = ev.note ? `<div class="highlight-tag">${ev.note}</div>` : '';
            let cashTag = ev.cashOnly ? '<span class="cash-badge">åƒ…æ”¶ç¾é‡‘</span>' : '';
            let icon = 'circle'; if(ev.type==='move')icon='directions_bus'; if(ev.type==='food')icon='restaurant'; if(ev.type==='spot')icon='photo_camera'; if(ev.type==='stay')icon='hotel';
            list.innerHTML += `
            <div class="m-event-item type-${ev.type}">
                <div class="m-event-icon-box"><span class="material-symbols-rounded" style="font-size:14px">${icon}</span></div>
                <div class="m-event-card" onclick="openDrawer('${ev.id}', ${currentMobileDay})">
                    <div class="m-card-img-header" style="${imgStyle}"><div class="m-card-title-overlay">${ev.title}</div></div>
                    <div class="m-card-body">
                        <div class="m-info-row"><span>${ev.start} - ${ev.end}</span><span style="color:var(--accent)">Â¥${ev.cost}</span></div>
                        ${!ev.img ? `<div class="m-card-title" style="color:black; text-shadow:none;">${ev.title}</div>` : ''}
                        <div class="m-card-desc">${ev.desc}</div>
                        ${noteHtml}
                        <div style="margin-top:6px;">${cashTag}</div>
                    </div>
                </div>
            </div>`;
        });
        list.innerHTML += `<button class="btn" style="width:100%;justify-content:center;margin-top:10px;" onclick="openEditor(${currentMobileDay})">+ æ–°å¢</button>`;
    }

    function renderDesktopTable() {
        const head = document.getElementById('d-header-row');
        const body = document.getElementById('d-body-row');
        head.innerHTML = '<th>é …ç›®</th>';
        let bodyHtml = '<tr><td style="padding:20px;vertical-align:top"><strong>è¦–è¦ºæ™‚é–“è»¸</strong></td>';
        daysMeta.forEach(d => { head.innerHTML += `<th>${d.date}</th>`; });
        daysMeta.forEach(d => {
            bodyHtml += `<td class="day-col"><div class="timeline-container" style="height:1200px;" onclick="openEditor(${d.id})">`;
            for(let h=6; h<24; h+=2) bodyHtml += `<div class="time-marker" style="top:${(h-6)*60}px">${h}:00</div>`;
            const events = appData.events['d'+d.id] || [];
            events.forEach(ev => {
                const [sh, sm] = ev.start.split(':').map(Number);
                const [eh, em] = ev.end.split(':').map(Number);
                const startMin = (sh - 6) * 60 + sm; 
                const duration = ((eh - sh) * 60) + (em - sm);
                const height = Math.max(40, duration);
                let bgStyle = ev.img ? `background-image:url('${ev.img}');` : '';
                let classMode = ev.img ? 'eb-bg' : 'eb-solid';
                let contentHtml = ev.img ? `<div class="eb-overlay"><div class="eb-time">${ev.start}</div><div class="eb-title">${ev.title}</div></div>` : `<div class="ev-time">${ev.start}</div><div class="ev-title">${ev.title}</div>`;
                if(ev.note) contentHtml += `<div class="highlight-tag" style="position:absolute;top:-6px;right:-6px;z-index:2;">${ev.note}</div>`;
                bodyHtml += `<div class="event-block type-${ev.type} ${classMode}" style="top:${startMin}px; height:${height}px; ${bgStyle}" onclick="event.stopPropagation(); openDrawer('${ev.id}', ${d.id})">${contentHtml}</div>`;
            });
            bodyHtml += `</div></td>`;
        });
        bodyHtml += '</tr>';
        body.innerHTML = bodyHtml;
    }

    function renderDB(filter = '') {
        const tbody = document.getElementById('db-tbody');
        tbody.innerHTML = '';
        daysMeta.forEach(d => {
            const events = appData.events['d'+d.id] || [];
            events.forEach(ev => {
                if(filter && !JSON.stringify(ev).toLowerCase().includes(filter.toLowerCase())) return;
                tbody.innerHTML += `<tr onclick="openDrawer('${ev.id}', ${d.id})"><td>${d.date}</td><td>${ev.start}</td><td>${ev.type}</td><td><strong>${ev.title}</strong></td><td>${ev.note ? `<span class="highlight-tag">${ev.note}</span>` : ''} ${ev.desc}</td><td>Â¥${ev.cost}</td></tr>`;
            });
        });
    }

    // --- Drawer Logic ---
    function openDrawer(evId, dayId) {
        currentEvId = evId; currentDayId = dayId;
        const ev = appData.events['d'+dayId].find(e=>e.id===evId);
        if(!ev) return;

        document.getElementById('d-drawer-title').innerText = ev.title;
        document.getElementById('d-drawer-type').innerText = ev.type.toUpperCase();
        document.getElementById('d-drawer-time').innerText = `${ev.start} - ${ev.end}`;
        document.getElementById('d-drawer-cost').innerText = `Â¥${ev.cost}`;
        document.getElementById('d-drawer-desc').innerText = ev.desc || '-';
        document.getElementById('d-drawer-advice').innerText = ev.advice || 'æš«ç„¡å»ºè­°';
        
        const imgCont = document.getElementById('d-drawer-img-container');
        if(ev.img) { imgCont.style.display='block'; document.getElementById('d-drawer-img').src=ev.img; } 
        else { imgCont.style.display='none'; }
        
        const onsenCont = document.getElementById('d-drawer-onsen-container');
        if(ev.onsen) { onsenCont.style.display='block'; document.getElementById('d-drawer-onsen').innerText=ev.onsen; }
        else { onsenCont.style.display='none'; }

        // Todo List
        const todoList = document.getElementById('d-todo-list');
        todoList.innerHTML = '';
        if(ev.todos && ev.todos.length>0) {
             ev.todos.forEach((t,i) => {
                todoList.innerHTML += `<div class="todo-item ${t.done?'done':''}" onclick="toggleTodo('${evId}',${dayId},${i})"><input type="checkbox" class="todo-checkbox" ${t.done?'checked':''}> <span class="drawer-todo-text ${t.done?'done':''}">${t.text}</span></div>`;
            });
        } else { todoList.innerHTML = '<div style="padding:10px;color:#999;font-size:12px;">ç„¡å¾…è¾¦</div>'; }

        if(!isPinned) document.getElementById('drawer-backdrop').classList.add('active');
        document.getElementById('detail-drawer').classList.add('active');
    }

    function toggleTodo(evId, dayId, idx) {
        const ev = appData.events['d'+dayId].find(e=>e.id===evId);
        if(ev && ev.todos) { ev.todos[idx].done = !ev.todos[idx].done; persist(); openDrawer(evId, dayId); }
    }

    function closeDrawer() {
        document.getElementById('drawer-backdrop').classList.remove('active');
        document.getElementById('detail-drawer').classList.remove('active');
        if(isPinned) togglePin();
    }

    function togglePin() {
        isPinned = !isPinned;
        document.body.classList.toggle('drawer-pinned', isPinned);
    }

    // --- Editor Logic ---
    function openEditor(dayId, evId=null) {
        currentDayId = dayId || currentDayId; currentEvId = evId || currentEvId;
        document.getElementById('editor-overlay').style.display = 'flex';
        
        // Reset
        document.getElementById('e-start').value = '10:00'; document.getElementById('e-end').value = '11:00';
        document.getElementById('e-title').value = ''; document.getElementById('e-cost').value = '';
        document.getElementById('e-desc').value = ''; document.getElementById('e-note').value = '';
        document.getElementById('e-img').value = ''; document.getElementById('e-todos').value = '';
        document.getElementById('e-advice').value = ''; document.getElementById('e-planb').value = '';
        document.getElementById('e-paid').checked = false; document.getElementById('e-cash').checked = false;

        if(currentEvId) {
             const ev = appData.events['d'+currentDayId].find(e=>e.id===currentEvId);
             document.getElementById('e-start').value = ev.start; document.getElementById('e-end').value = ev.end;
             document.getElementById('e-title').value = ev.title; document.getElementById('e-cost').value = ev.cost;
             document.getElementById('e-desc').value = ev.desc; document.getElementById('e-note').value = ev.note || '';
             document.getElementById('e-img').value = ev.img || ''; 
             document.getElementById('e-todos').value = ev.todos ? ev.todos.map(t=>t.text).join('\n') : '';
             document.getElementById('e-advice').value = ev.advice || '';
             document.getElementById('e-paid').checked = ev.paid || false;
             document.getElementById('e-cash').checked = ev.cashOnly || false;
        }
    }
    
    function closeEditor() { document.getElementById('editor-overlay').style.display = 'none'; }
    
    function saveEvent() {
        const title = document.getElementById('e-title').value;
        if(!title) return alert('è«‹è¼¸å…¥åç¨±');
        
        const todoRaw = document.getElementById('e-todos').value;
        const newTodos = todoRaw.split('\n').filter(t=>t.trim()).map(t=>({text:t, done:false}));

        const newEv = {
            id: currentEvId || 'e'+Date.now(),
            start: document.getElementById('e-start').value, end: document.getElementById('e-end').value,
            title: title, type: document.getElementById('e-type').value,
            cost: parseInt(document.getElementById('e-cost').value) || 0,
            paid: document.getElementById('e-paid').checked,
            cashOnly: document.getElementById('e-cash').checked,
            desc: document.getElementById('e-desc').value,
            note: document.getElementById('e-note').value,
            img: document.getElementById('e-img').value,
            advice: document.getElementById('e-advice').value,
            planb: document.getElementById('e-planb').value,
            todos: newTodos
        };
        
        if(!appData.events['d'+currentDayId]) appData.events['d'+currentDayId] = [];
        if(currentEvId) {
            const idx = appData.events['d'+currentDayId].findIndex(e=>e.id===currentEvId);
            appData.events['d'+currentDayId][idx] = newEv;
        } else { appData.events['d'+currentDayId].push(newEv); }
        
        persist(); closeEditor(); renderAll();
        if(currentEvId) openDrawer(currentEvId, currentDayId);
    }
    
    function deleteEvent() {
        if(confirm('åˆªé™¤ï¼Ÿ')) {
            appData.events['d'+currentDayId] = appData.events['d'+currentDayId].filter(e=>e.id!==currentEvId);
            persist(); closeDrawer(); renderAll();
        }
    }

    // --- Utils ---
    function setMobileDay(id) { currentMobileDay = id; renderMobile(); }
    function persist() { localStorage.setItem(STORAGE_KEY, JSON.stringify(appData)); }
    function updateDashboard() {
        let total = 0, cashNeeded = 0;
        Object.values(appData.events).forEach(evs => evs.forEach(e => {
            total += (e.cost||0);
            if(e.cashOnly && !e.paid) cashNeeded += (e.cost||0);
        }));
        document.getElementById('dash-total').innerText = `Â¥${total.toLocaleString()}`;
        document.getElementById('dash-cash').innerText = `Â¥${cashNeeded.toLocaleString()}`;
    }
    function exportData() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData));
        const node = document.createElement('a'); node.setAttribute("href", dataStr); node.setAttribute("download", "kyushu_plan_v26.json"); document.body.appendChild(node); node.click(); node.remove();
    }
    function importData() { document.getElementById('import-file').click(); }
    function processImport(input) { const file = input.files[0]; const reader = new FileReader(); reader.onload = (e) => { appData = JSON.parse(e.target.result); persist(); location.reload(); }; reader.readAsText(file); }

    init();
  </script>
</body>
</html>
